<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDOT CCTV Operations Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #003366; font-size: 28px; }
        .subtitle { color: #666; margin-top: 5px; }

        .toolbar { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 12px 20px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        .search-input:focus { outline: none; border-color: #003366; }

        .bulk-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .btn { background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn:hover { background: #004488; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 32px; font-weight: bold; color: #003366; }
        .stat-label { color: #666; margin-top: 5px; font-size: 14px; }

        .filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .filter-btn.active { border-color: #003366; background: #003366; color: white; }

        .camera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .camera-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .camera-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .camera-card.selected { border: 2px solid #003366; }

        .camera-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .camera-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .camera-name { font-weight: 600; color: #003366; flex: 1; }
        .health-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .health-online { background: #4caf50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.6); }
        .health-degraded { background: #ff9800; box-shadow: 0 0 6px rgba(255, 152, 0, 0.6); }
        .health-offline { background: #f44336; box-shadow: 0 0 6px rgba(244, 67, 54, 0.6); }
        .health-unknown { background: #9e9e9e; }
        .camera-info { font-size: 14px; color: #666; margin: 4px 0; margin-left: 28px; }

        .camera-snapshot { margin: 10px 0 10px 28px; border-radius: 6px; overflow: hidden; cursor: pointer; }
        .camera-snapshot img { width: 100%; height: auto; display: block; transition: opacity 0.2s; }
        .camera-snapshot img:hover { opacity: 0.9; }
        .snapshot-placeholder { background: #f5f5f5; padding: 40px; text-align: center; color: #999; font-size: 12px; }

        .snapshot-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .snapshot-modal-content { margin: 2% auto; display: block; max-width: 90%; max-height: 90%; }
        .snapshot-modal-close { position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
        .snapshot-modal-close:hover { color: #ccc; }

        .camera-actions { display: flex; gap: 8px; margin-top: 12px; margin-left: 28px; }
        .action-btn { padding: 6px 12px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; }
        .action-btn.reboot { background: #dc3545; color: white; }
        .action-btn.reboot:hover { background: #c82333; }
        .action-btn.snapshot { background: #28a745; color: white; }
        .action-btn.snapshot:hover { background: #218838; }

        .loading { text-align: center; padding: 40px; color: #666; }
        .no-results { text-align: center; padding: 40px; color: #999; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { font-size: 20px; font-weight: 600; color: #003366; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #003366; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* Notifications */
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 20px 25px; border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.2); z-index: 2000; display: none; min-width: 350px; max-width: 500px; white-space: pre-line; font-size: 16px; font-weight: 500; }
        .notification.show { display: block; animation: slideIn 0.3s ease; }
        .notification.success { border-left: 6px solid #28a745; background: #f0fff4; }
        .notification.error { border-left: 6px solid #dc3545; background: #fff5f5; }
        .notification.info { border-left: 6px solid #17a2b8; background: #f0f9ff; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }

        /* Floating Progress Indicator */
        .progress-float { position: fixed; bottom: 20px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.3); z-index: 1999; display: none; min-width: 400px; max-width: 500px; border-left: 6px solid #003366; }
        .progress-float.show { display: block; animation: slideUp 0.3s ease; }
        .progress-float-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .progress-float-title { font-weight: bold; color: #003366; font-size: 16px; }
        .progress-float-close { cursor: pointer; font-size: 20px; color: #999; line-height: 1; padding: 0 5px; }
        .progress-float-close:hover { color: #333; }
        @keyframes slideUp { from { transform: translateY(400px); } to { transform: translateY(0); } }

        /* Trends Charts */
        .trends-section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .trends-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .trends-title { font-size: 18px; font-weight: 600; color: #003366; }
        .trends-controls { display: flex; gap: 10px; align-items: center; }
        .trends-select { padding: 6px 12px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; }
        .charts-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .chart-container { background: #fafafa; padding: 15px; border-radius: 6px; height: 300px; position: relative; }
        .chart-container h4 { font-size: 14px; color: #666; margin-bottom: 10px; }
        .chart-container canvas { max-height: 250px; }
        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }

        /* Navigation Tabs */
        .nav-tabs { display: flex; border-bottom: 2px solid #003366; }
        .tab-btn { flex: 1; background: white; border: none; padding: 15px 20px; font-size: 16px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 3px solid transparent; transition: all 0.2s; }
        .tab-btn:hover { background: #f5f5f5; color: #003366; }
        .tab-btn.active { color: #003366; border-bottom-color: #003366; background: #f0f4f8; }

        /* Groups Section */
        .group-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .group-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .group-name { font-size: 18px; font-weight: 600; color: #003366; }
        .group-type-badge { display: inline-block; padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .badge-highway { background: #e3f2fd; color: #1565c0; }
        .badge-county { background: #f3e5f5; color: #7b1fa2; }
        .badge-custom { background: #e8f5e9; color: #2e7d32; }
        .group-description { color: #666; font-size: 14px; margin: 10px 0; }
        .group-stats { display: flex; gap: 20px; margin: 15px 0; font-size: 14px; color: #666; }
        .group-stat-item { display: flex; align-items: center; gap: 5px; }
        .group-actions { display: flex; gap: 8px; margin-top: 15px; }
        .group-actions .btn { padding: 6px 12px; font-size: 13px; }

        /* Member List in Group Modal */
        .member-list { max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin-top: 10px; }
        .member-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .member-item:last-child { border-bottom: none; }
        .member-item:hover { background: #f5f5f5; }
        .member-name { font-size: 14px; color: #333; }
        .member-remove-btn { color: #dc3545; cursor: pointer; font-size: 18px; padding: 0 8px; }
        .member-remove-btn:hover { color: #c82333; }

        /* Camera Selector */
        .camera-selector { max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
        .camera-selector-item { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; }
        .camera-selector-item:hover { background: #f5f5f5; }
        .camera-selector-item input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
        .camera-selector-search { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; margin-bottom: 10px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• FDOT CCTV Operations Tool</h1>
            <div class="subtitle">District 3 Camera Management System</div>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCameras">-</div>
                <div class="stat-label">Total Cameras</div>
            </div>
            <div class="stat-card" style="background: #e8f5e9;">
                <div class="stat-value" style="color: #2e7d32;" id="onlineCameras">-</div>
                <div class="stat-label">üü¢ Online</div>
            </div>
            <div class="stat-card" style="background: #fff3e0;">
                <div class="stat-value" style="color: #f57c00;" id="degradedCameras">-</div>
                <div class="stat-label">üü° Degraded</div>
            </div>
            <div class="stat-card" style="background: #ffebee;">
                <div class="stat-value" style="color: #c62828;" id="offlineCameras">-</div>
                <div class="stat-label">üî¥ Offline</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="systemHealth">-</div>
                <div class="stat-label">System Health</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="problemCameras">-</div>
                <div class="stat-label">Problem Cameras</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgImageQuality">-</div>
                <div class="stat-label">Avg Image Quality</div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="nav-tabs" style="background: white; padding: 0; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); overflow: hidden;">
            <button class="tab-btn active" onclick="switchTab('cameras')">üìπ Cameras</button>
            <button class="tab-btn" onclick="switchTab('groups')">üìÅ Groups</button>
            <button class="tab-btn" onclick="switchTab('maintenance')">üîß Maintenance</button>
            <button class="tab-btn" onclick="switchTab('sla')">üìä SLA Compliance</button>
            <button class="tab-btn" onclick="switchTab('alerts')">üîî Alerts</button>
        </div>

        <!-- Groups Management Section (Hidden by default) -->
        <div id="groupsSection" style="display: none;">
            <div class="toolbar">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h3 style="color: #003366; margin: 0;">Camera Groups</h3>
                    <button class="btn btn-success" onclick="openCreateGroupModal()">+ Create Group</button>
                </div>

                <input type="text" class="search-input" id="groupSearchInput" placeholder="üîç Search groups by name or type..." style="margin-bottom: 0;" onkeyup="searchGroups()" />
            </div>

            <div id="groupsContainer" class="camera-grid">
                <div class="loading">Loading groups...</div>
            </div>
        </div>

        <!-- Maintenance & Downtime Section (Hidden by default) -->
        <div id="maintenanceSection" style="display: none;">
            <!-- Downtime Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="stat-card" style="background: #fff3e0;">
                    <div class="stat-value" style="color: #f57c00;" id="currentlyDown">-</div>
                    <div class="stat-label">Currently Down</div>
                </div>
                <div class="stat-card" style="background: #e3f2fd;">
                    <div class="stat-value" style="color: #1565c0;" id="totalIncidents">-</div>
                    <div class="stat-label">Incidents (30d)</div>
                </div>
                <div class="stat-card" style="background: #f3e5f5;">
                    <div class="stat-value" style="color: #7b1fa2;" id="totalDowntimeHours">-</div>
                    <div class="stat-label">Total Downtime (hrs)</div>
                </div>
                <div class="stat-card" style="background: #e8f5e9;">
                    <div class="stat-value" style="color: #2e7d32;" id="avgDowntime">-</div>
                    <div class="stat-label">Avg Downtime (min)</div>
                </div>
            </div>

            <div class="toolbar" style="margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3 style="color: #003366; margin: 0;">Maintenance Windows</h3>
                    <button class="btn btn-success" onclick="openScheduleMaintenanceModal()">+ Schedule Maintenance</button>
                </div>
            </div>

            <!-- Maintenance Windows List -->
            <div id="maintenanceWindowsContainer" style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 25px;">
                <div class="loading">Loading maintenance windows...</div>
            </div>

            <!-- Top Cameras by Downtime -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #003366; margin: 0 0 15px 0;">Top Cameras by Downtime (30 days)</h3>
                <div id="topDowntimeCameras">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>

        <!-- SLA Compliance Section (Hidden by default) -->
        <div id="slaSection" style="display: none;">
            <!-- SLA Summary Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <div class="stat-value" style="color: white;" id="slaStandardCompliance">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Standard (95%) Compliance</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="stat-value" style="color: white;" id="slaPremiumCompliance">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Premium (99%) Compliance</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="stat-value" style="color: white;" id="slaCriticalCompliance">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Critical (99.9%) Compliance</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="stat-value" style="color: white;" id="slaViolationsCount">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Active Violations</div>
                </div>
            </div>

            <!-- Time Period Selector -->
            <div style="background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <label style="margin-right: 10px; font-weight: 600; color: #003366;">Analysis Period:</label>
                <select id="slaPeriodSelect" onchange="loadSlaData()" style="padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
                    <option value="7">Last 7 Days</option>
                    <option value="30" selected>Last 30 Days</option>
                    <option value="60">Last 60 Days</option>
                    <option value="90">Last 90 Days</option>
                </select>
                <button class="btn btn-secondary" onclick="loadSlaData()" style="margin-left: 10px; padding: 8px 16px;">üîÑ Refresh</button>
            </div>

            <!-- SLA Violations -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #003366; margin: 0 0 15px 0;">üö® SLA Violations & At-Risk Cameras</h3>
                <div id="slaViolationsContainer">
                    <div class="loading">Loading violations...</div>
                </div>
            </div>

            <!-- SLA Target Breakdown -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                <h3 style="color: #003366; margin: 0 0 15px 0;">üìã SLA Target Breakdown</h3>
                <div id="slaTargetBreakdown">
                    <div class="loading">Loading target breakdown...</div>
                </div>
            </div>

            <!-- Monthly Compliance Report -->
            <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h3 style="color: #003366; margin: 0 0 15px 0;">üìÖ Monthly Compliance Report</h3>
                <div id="monthlyComplianceReport">
                    <div class="loading">Loading monthly report...</div>
                </div>
            </div>
        </div>

        <!-- Alerts Management Section (Hidden by default) -->
        <div id="alertsSection" style="display: none;">
            <!-- Alert Statistics Cards -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
                <div class="stat-card" style="background: linear-gradient(135deg, #f44336 0%, #e91e63 100%);">
                    <div class="stat-value" style="color: white;" id="activeAlertsCount">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Active Alerts</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%);">
                    <div class="stat-value" style="color: white;" id="totalAlertsCount">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Total Alerts (30d)</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #2196f3 0%, #03a9f4 100%);">
                    <div class="stat-value" style="color: white;" id="alertRulesCount">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Alert Rules</div>
                </div>
                <div class="stat-card" style="background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);">
                    <div class="stat-value" style="color: white;" id="resolvedAlertsCount">-</div>
                    <div class="stat-label" style="color: rgba(255,255,255,0.9);">Resolved (30d)</div>
                </div>
            </div>

            <!-- Tab Navigation for Alerts Sub-sections -->
            <div style="background: white; padding: 10px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <button class="tab-btn active" onclick="switchAlertsTab('active')" id="activeAlertsTab" style="margin: 0 5px;">üö® Active Alerts</button>
                <button class="tab-btn" onclick="switchAlertsTab('rules')" id="alertRulesTab" style="margin: 0 5px;">‚öôÔ∏è Alert Rules</button>
                <button class="tab-btn" onclick="switchAlertsTab('history')" id="alertHistoryTab" style="margin: 0 5px;">üìã History</button>
            </div>

            <!-- Active Alerts View -->
            <div id="activeAlertsView" style="display: block;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h3 style="color: #003366; margin: 0 0 15px 0;">üö® Active Alerts</h3>
                    <div id="activeAlertsContainer">
                        <div class="loading">Loading active alerts...</div>
                    </div>
                </div>
            </div>

            <!-- Alert Rules View -->
            <div id="alertRulesView" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #003366; margin: 0;">‚öôÔ∏è Alert Rules</h3>
                        <button class="btn btn-success" onclick="openCreateAlertRuleModal()">+ Create Rule</button>
                    </div>
                    <div id="alertRulesContainer">
                        <div class="loading">Loading alert rules...</div>
                    </div>
                </div>
            </div>

            <!-- Alert History View -->
            <div id="alertHistoryView" style="display: none;">
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="color: #003366; margin: 0;">üìã Alert History</h3>
                        <div>
                            <select id="historyDaysFilter" onchange="loadAlertHistory()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px;">
                                <option value="7" selected>Last 7 Days</option>
                                <option value="30">Last 30 Days</option>
                                <option value="90">Last 90 Days</option>
                            </select>
                            <select id="historySeverityFilter" onchange="loadAlertHistory()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                                <option value="">All Severities</option>
                                <option value="critical">Critical</option>
                                <option value="error">Error</option>
                                <option value="warning">Warning</option>
                                <option value="info">Info</option>
                            </select>
                        </div>
                    </div>
                    <div id="alertHistoryContainer">
                        <div class="loading">Loading alert history...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Image Analysis Section -->
        <div class="ai-analysis-section" id="aiAnalysisSection" style="margin-bottom: 20px;">
            <div class="trends-header">
                <div class="trends-title">AI Image Quality Analysis</div>
                <div class="trends-controls">
                    <button class="btn btn-secondary" onclick="loadAiAnalysis()" style="padding: 6px 12px; font-size: 13px;">Refresh</button>
                    <button class="btn btn-primary" onclick="runBatchAnalysis()" style="padding: 6px 12px; font-size: 13px;">Analyze Sample</button>
                </div>
            </div>
            <div class="ai-quality-summary" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 15px;">
                <div class="quality-stat" style="background: #1a3d2e; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #4ade80;" id="aiExcellent">-</div>
                    <div style="font-size: 12px; color: #9ca3af;">Excellent (80+)</div>
                </div>
                <div class="quality-stat" style="background: #3d3a1a; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #fbbf24;" id="aiAcceptable">-</div>
                    <div style="font-size: 12px; color: #9ca3af;">Acceptable (50-79)</div>
                </div>
                <div class="quality-stat" style="background: #3d1a1a; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #f87171;" id="aiPoor">-</div>
                    <div style="font-size: 12px; color: #9ca3af;">Poor (&lt;50)</div>
                </div>
                <div class="quality-stat" style="background: #1e293b; padding: 15px; border-radius: 8px; text-align: center;">
                    <div style="font-size: 24px; font-weight: bold; color: #60a5fa;" id="aiAnalyzed">-</div>
                    <div style="font-size: 12px; color: #9ca3af;">Total Analyzed</div>
                </div>
            </div>
            <div id="aiAttentionCameras" style="margin-top: 15px;">
                <div style="color: #9ca3af; font-size: 13px;">Loading cameras needing attention...</div>
            </div>
        </div>

        <!-- Trends Section -->
        <div class="trends-section" id="trendsSection">
            <div class="trends-header">
                <div class="trends-title">System Health Trends</div>
                <div class="trends-controls">
                    <select class="trends-select" id="trendsPeriod" onchange="loadTrends()">
                        <option value="24">Last 24 Hours</option>
                        <option value="48">Last 48 Hours</option>
                        <option value="168">Last 7 Days</option>
                    </select>
                    <button class="btn btn-secondary" onclick="exportCSV()" style="padding: 6px 12px; font-size: 13px;">Export CSV</button>
                </div>
            </div>
            <div class="charts-grid">
                <div class="chart-container">
                    <h4>Daily Uptime Trend (%)</h4>
                    <canvas id="healthChart"></canvas>
                </div>
                <div class="chart-container">
                    <h4>Average Response Time Trend (ms)</h4>
                    <canvas id="responseChart"></canvas>
                </div>
            </div>
        </div>

        <div class="toolbar">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search cameras by name, IP, location, or highway (e.g., 'I10', '10.164', 'MM 5')..." />

            <div class="filters">
                <button class="filter-btn active" onclick="filterHighway('all')">All</button>
                <button class="filter-btn" onclick="filterHighway('I10')">I-10</button>
                <button class="filter-btn" onclick="filterHighway('I110')">I-110</button>
                <button class="filter-btn" onclick="filterHighway('US90')">US-90</button>
                <button class="filter-btn" onclick="filterHighway('US98')">US-98</button>
                <span style="margin: 0 10px; color: #ccc;">|</span>
                <button class="filter-btn" onclick="filterHealth('online')">üü¢ Online Only</button>
                <button class="filter-btn" onclick="filterHealth('offline')">üî¥ Offline Only</button>
                <button class="filter-btn" onclick="filterHealth('problem')">‚ö†Ô∏è Problem Cameras</button>
            </div>

            <div class="bulk-actions">
                <button class="btn btn-secondary" onclick="testAllCameras()">üîç Test All</button>
                <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
                <button class="btn btn-danger" onclick="bulkReboot()" id="bulkRebootBtn" disabled>Reboot Selected</button>
                <button class="btn btn-success" onclick="bulkSnapshot()" id="bulkSnapshotBtn" disabled>Snapshot Selected</button>
            </div>
        </div>

        <div id="cameraContainer">
            <div class="loading">Loading cameras...</div>
        </div>
    </div>

    <!-- Reboot Modal -->
    <div id="rebootModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Reboot Camera</div>
            <div class="form-group">
                <label class="form-label">Camera:</label>
                <div id="rebootCameraName" style="font-weight: 600;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Operator Name: *</label>
                <input type="text" class="form-input" id="rebootOperator" placeholder="Your name" />
            </div>
            <div class="form-group">
                <label class="form-label">Reason for Reboot: *</label>
                <textarea class="form-textarea" id="rebootReason" placeholder="e.g., Camera not responding, scheduled maintenance"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRebootModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmReboot()">Reboot Camera</button>
            </div>
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div id="snapshotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Capture Snapshots</div>
            <div class="form-group">
                <label class="form-label">Cameras Selected: <span id="snapshotCameraCount">0</span></label>
            </div>
            <div class="form-group">
                <label class="form-label">Operator Name: *</label>
                <input type="text" class="form-input" id="snapshotOperator" placeholder="Your name" />
            </div>
            <div class="form-group">
                <label class="form-label">Duration (minutes): *</label>
                <input type="number" class="form-input" id="snapshotDuration" value="60" min="1" max="1440" />
            </div>
            <div class="form-group">
                <label class="form-label">Interval (seconds): *</label>
                <input type="number" class="form-input" id="snapshotInterval" value="300" min="30" max="3600" />
            </div>
            <div class="form-group">
                <label class="form-label">Email Results To:</label>
                <input type="text" class="form-input" id="snapshotEmails" placeholder="email1@domain.com, email2@domain.com (optional)" />
                <small style="color: #666; font-size: 12px;">Leave blank for no email, or enter comma-separated addresses</small>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSnapshotModal()">Cancel</button>
                <button class="btn btn-success" id="snapshotStartBtn" onclick="confirmSnapshot()">Start Capture</button>
            </div>
        </div>
    </div>

    <!-- Create/Edit Group Modal -->
    <div id="groupModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" id="groupModalTitle">Create Group</div>
            <div class="form-group">
                <label class="form-label">Group Name: *</label>
                <input type="text" class="form-input" id="groupName" placeholder="e.g., I-10 Cameras, Bay County" />
            </div>
            <div class="form-group">
                <label class="form-label">Group Type: *</label>
                <select class="form-select" id="groupType">
                    <option value="highway">Highway</option>
                    <option value="county">County</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Description:</label>
                <textarea class="form-textarea" id="groupDescription" placeholder="Optional description of this group"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeGroupModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveGroup()" id="saveGroupBtn">Create Group</button>
            </div>
        </div>
    </div>

    <!-- Add Cameras to Group Modal -->
    <div id="addCamerasModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">Add Cameras to <span id="addCamerasGroupName"></span></div>
            <div class="form-group">
                <input type="text" class="camera-selector-search" id="cameraSearch" placeholder="üîç Search cameras..." onkeyup="filterCameraSelector()" />
                <div class="camera-selector" id="cameraSelector">
                    <div class="loading">Loading cameras...</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeAddCamerasModal()">Cancel</button>
                <button class="btn btn-success" onclick="confirmAddCameras()">Add Selected</button>
            </div>
        </div>
    </div>

    <!-- View Group Details Modal -->
    <div id="viewGroupModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <span id="viewGroupName"></span>
                <span id="viewGroupTypeBadge" class="group-type-badge" style="margin-left: 10px;"></span>
            </div>
            <div class="form-group">
                <div id="viewGroupDescription" style="color: #666; margin-bottom: 15px;"></div>
                <div class="group-stats" id="viewGroupStats">
                    <div class="group-stat-item">
                        <span>üìπ</span>
                        <span id="viewGroupMemberCount">0 cameras</span>
                    </div>
                    <div class="group-stat-item">
                        <span>üìÖ</span>
                        <span id="viewGroupCreated"></span>
                    </div>
                </div>
            </div>
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label class="form-label" style="margin-bottom: 0;">Members:</label>
                    <button class="btn btn-success" style="padding: 4px 10px; font-size: 12px;" onclick="openAddCamerasFromView()">+ Add Cameras</button>
                </div>
                <div class="member-list" id="viewGroupMembers">
                    <div style="text-align: center; color: #999; padding: 20px;">No cameras in this group</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeViewGroupModal()">Close</button>
                <button class="btn btn-danger" onclick="deleteGroupConfirm()">Delete Group</button>
                <button class="btn btn-success" onclick="openEditGroupModal()">Edit Group</button>
            </div>
        </div>
    </div>

    <!-- Schedule Maintenance Modal -->
    <div id="maintenanceModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <span id="maintenanceModalTitle">Schedule Maintenance</span>
            </div>
            <div class="form-group">
                <label class="form-label">Camera *</label>
                <select id="maintenanceCameraSelect" class="form-input" style="padding: 8px;">
                    <option value="">Select camera...</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Maintenance Type *</label>
                <select id="maintenanceType" class="form-input" style="padding: 8px;">
                    <option value="planned">Planned</option>
                    <option value="emergency">Emergency</option>
                    <option value="vendor">Vendor</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Start Time *</label>
                <input type="datetime-local" id="maintenanceStart" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label">End Time *</label>
                <input type="datetime-local" id="maintenanceEnd" class="form-input" />
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <textarea id="maintenanceDescription" class="form-input" rows="3" placeholder="Describe the maintenance work..."></textarea>
            </div>
            <div class="form-group">
                <label class="form-label">Technician</label>
                <input type="text" id="maintenanceTechnician" class="form-input" placeholder="Technician name" />
            </div>
            <div class="form-group">
                <label class="form-label">Vendor</label>
                <input type="text" id="maintenanceVendor" class="form-input" placeholder="Vendor name (if applicable)" />
            </div>
            <div class="form-group">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="maintenanceSuppressAlerts" checked style="margin-right: 8px;" />
                    <span>Suppress alerts during maintenance window</span>
                </label>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeMaintenanceModal()">Cancel</button>
                <button class="btn btn-success" onclick="saveMaintenanceWindow()">Schedule</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Floating Progress Indicator -->
    <div id="snapshotProgressFloat" class="progress-float">
        <div class="progress-float-header">
            <div class="progress-float-title">üì∏ Capturing Snapshots...</div>
            <div class="progress-float-close" onclick="hideSnapshotProgress()">√ó</div>
        </div>
        <div style="margin-bottom: 10px;">
            <span id="snapshotProgressText" style="font-weight: bold; color: #003366; font-size: 18px;">0%</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 25px; overflow: hidden;">
            <div id="snapshotProgressBar" style="width: 0%; background: linear-gradient(90deg, #003366, #0066cc); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
        </div>
        <div id="snapshotProgressDetails" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
    </div>

    <script>
        let allCameras = [];
        let healthData = {};
        let healthStats = {};
        let currentFilter = 'all';
        let healthFilter = 'all';
        let selectedCameras = new Set();
        let currentRebootCamera = null;
        let currentSnapshotSession = null;
        let snapshotProgressInterval = null;
        let healthChart = null;
        let responseChart = null;

        // Load and render trends charts
        async function loadTrends() {
            try {
                const hours = document.getElementById('trendsPeriod').value;
                const days = Math.ceil(hours / 24);

                // Use new reporting API for better daily trends
                const response = await fetch(`/api/reports/trends?days=${days}`);
                const data = await response.json();

                if (!data.trends || data.trends.length === 0) {
                    console.log('No trend data available yet');
                    return;
                }

                // Sort trends by date
                data.trends.sort((a, b) => new Date(a.date) - new Date(b.date));

                const labels = data.trends.map(d => {
                    const date = new Date(d.date);
                    return days <= 1
                        ? date.toLocaleDateString([], {month: 'short', day: 'numeric', hour: '2-digit'})
                        : date.toLocaleDateString([], {month: 'short', day: 'numeric'});
                });

                // Uptime Trend Chart
                const healthCtx = document.getElementById('healthChart').getContext('2d');
                if (healthChart) healthChart.destroy();
                healthChart = new Chart(healthCtx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'System Uptime %',
                            data: data.trends.map(d => d.uptime_percentage),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            fill: true,
                            tension: 0.3,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: Math.max(0, Math.min(...data.trends.map(d => d.uptime_percentage)) - 5),
                                max: 100,
                                ticks: { callback: v => v.toFixed(1) + '%' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const trend = data.trends[context.dataIndex];
                                        return [
                                            `Uptime: ${context.parsed.y.toFixed(2)}%`,
                                            `Online: ${trend.online_count.toLocaleString()}`,
                                            `Degraded: ${trend.degraded_count}`,
                                            `Offline: ${trend.offline_count}`,
                                            `Cameras: ${trend.cameras_checked}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

                // Response Time Trend Chart
                const responseCtx = document.getElementById('responseChart').getContext('2d');
                if (responseChart) responseChart.destroy();
                responseChart = new Chart(responseCtx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Avg Response Time',
                            data: data.trends.map(d => d.avg_response_time),
                            backgroundColor: 'rgba(33, 150, 243, 0.6)',
                            borderColor: '#2196f3',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                min: 0,
                                ticks: { callback: v => v.toFixed(1) + 'ms' }
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const trend = data.trends[context.dataIndex];
                                        return [
                                            `Response: ${context.parsed.y.toFixed(2)}ms`,
                                            `Total Checks: ${trend.total_checks.toLocaleString()}`
                                        ];
                                    }
                                }
                            }
                        }
                    }
                });

            } catch (error) {
                console.error('Error loading trends:', error);
            }
        }

        // Export health data as CSV
        function exportCSV() {
            const hours = document.getElementById('trendsPeriod').value;
            window.location.href = `/api/health/export-csv?hours=${hours}`;
        }

        // Load cameras on page load
        async function loadCameras() {
            try {
                console.log('Loading cameras...');
                const response = await fetch('/api/cameras/list');
                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Data parsed:', data.total, 'cameras');
                allCameras = data.cameras;
                document.getElementById('totalCameras').textContent = data.total;

                // Display cameras immediately
                const container = document.getElementById('cameraContainer');
                container.innerHTML = '<div class="camera-grid">' + allCameras.map(cam => `
                    <div class="camera-card ${selectedCameras.has(cam.id) ? 'selected' : ''}" id="card-${cam.id}">
                        <div class="camera-header">
                            <input type="checkbox" class="camera-checkbox"
                                   ${selectedCameras.has(cam.id) ? 'checked' : ''}
                                   onchange="toggleCamera('${cam.id}')" />
                            <div class="camera-name">${cam.name}<span class="health-indicator health-unknown"></span></div>
                        </div>
                        <div class="camera-info">üìç ${cam.location}</div>
                        <div class="camera-info">üåê ${cam.ip}</div>
                        <div class="camera-actions">
                            <button class="action-btn reboot" onclick="showRebootModal('${cam.id}')">üîÑ Reboot</button>
                            <button class="action-btn snapshot" onclick="snapshotSingle('${cam.id}')">üì∏ Snapshot</button>
                        </div>
                    </div>
                `).join('') + '</div>';

                // Load health data after cameras are displayed
                loadHealthData();
            } catch (error) {
                console.error('Error loading cameras:', error);
                document.getElementById('cameraContainer').innerHTML = '<div class="no-results">Error loading cameras: ' + error.message + '</div>';
            }
        }

        // Load health data
        async function loadHealthData() {
            try {
                console.log('Loading health data...');
                const response = await fetch('/api/dashboard/health');
                const data = await response.json();

                // Create health lookup by camera name
                healthData = {};
                if (data.cameras) {
                    data.cameras.forEach(cam => {
                        healthData[cam.camera_name] = cam;
                    });
                }
                console.log('Health data loaded for', Object.keys(healthData).length, 'cameras');

                // Store statistics
                healthStats = data.statistics || {};

                // Update stats display
                updateHealthStats();

                // Update health indicators on existing camera cards
                allCameras.forEach(cam => {
                    const card = document.getElementById('card-' + cam.id);
                    if (card) {
                        const nameDiv = card.querySelector('.camera-name');
                        if (nameDiv) {
                            const health = healthData[cam.name];
                            const indicator = nameDiv.querySelector('.health-indicator');
                            if (indicator && health) {
                                indicator.className = 'health-indicator health-' + health.status;
                                indicator.title = health.status.charAt(0).toUpperCase() + health.status.slice(1) +
                                    (health.last_check ? ' (checked ' + new Date(health.last_check).toLocaleString() + ')' : '');
                            }
                        }
                    }
                });
                console.log('Health indicators updated');
            } catch (error) {
                console.error('Error loading health data:', error);
            }
        }

        // Update health statistics display
        function updateHealthStats() {
            document.getElementById('onlineCameras').textContent = healthStats.online || 0;
            document.getElementById('degradedCameras').textContent = healthStats.degraded || 0;
            document.getElementById('offlineCameras').textContent = healthStats.offline || 0;
            document.getElementById('systemHealth').textContent = (healthStats.system_health_percentage || 0) + '%';
            document.getElementById('problemCameras').textContent = healthStats.problem_cameras || 0;
        }

        // Load AI analysis data
        async function loadAiAnalysis() {
            try {
                const response = await fetch('/api/analysis/quality');
                if (!response.ok) {
                    throw new Error('AI analysis not available');
                }
                const data = await response.json();

                // Update summary stats
                const summary = data.summary || {};
                document.getElementById('aiExcellent').textContent = summary.excellent_count || 0;
                document.getElementById('aiAcceptable').textContent = summary.acceptable_count || 0;
                document.getElementById('aiPoor').textContent = summary.poor_count || 0;
                document.getElementById('aiAnalyzed').textContent = summary.total_analyzed || 0;
                document.getElementById('avgImageQuality').textContent = summary.average_score ? summary.average_score + '%' : '-';

                // Load cameras needing attention
                const attentionResponse = await fetch('/api/analysis/attention');
                if (attentionResponse.ok) {
                    const attentionData = await attentionResponse.json();
                    displayAttentionCameras(attentionData.cameras || []);
                }
            } catch (error) {
                console.log('AI analysis not available:', error.message);
                document.getElementById('avgImageQuality').textContent = 'N/A';
                document.getElementById('aiAttentionCameras').innerHTML = '<div style="color: #6b7280; font-size: 13px;">AI analysis not yet run. Click "Analyze Sample" to get started.</div>';
            }
        }

        // Display cameras needing attention
        function displayAttentionCameras(cameras) {
            const container = document.getElementById('aiAttentionCameras');
            if (!cameras || cameras.length === 0) {
                container.innerHTML = '<div style="color: #4ade80; font-size: 13px;">No cameras need attention - all analyzed cameras have good image quality!</div>';
                return;
            }

            let html = '<div style="font-size: 13px; color: #f87171; margin-bottom: 10px;">Cameras Needing Attention (' + cameras.length + '):</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px;">';

            cameras.slice(0, 6).forEach(cam => {
                const scoreColor = cam.quality_score < 30 ? '#f87171' : cam.quality_score < 50 ? '#fbbf24' : '#9ca3af';
                html += '<div style="background: #1e293b; padding: 10px; border-radius: 6px; border-left: 3px solid ' + scoreColor + ';">';
                html += '<div style="font-weight: 600; font-size: 13px;">' + cam.camera_name + '</div>';
                html += '<div style="font-size: 12px; color: ' + scoreColor + ';">Score: ' + cam.quality_score + '/100</div>';
                if (cam.issues && cam.issues.length > 0) {
                    html += '<div style="font-size: 11px; color: #9ca3af; margin-top: 4px;">' + cam.issues.slice(0, 2).join(', ') + '</div>';
                }
                html += '</div>';
            });

            html += '</div>';
            if (cameras.length > 6) {
                html += '<div style="color: #6b7280; font-size: 12px; margin-top: 8px;">...and ' + (cameras.length - 6) + ' more</div>';
            }

            container.innerHTML = html;
        }

        // Run batch analysis on sample cameras
        async function runBatchAnalysis() {
            try {
                showNotification('Starting AI analysis on sample cameras...', 'info');
                const response = await fetch('/api/analysis/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ cameras: [] }) // Empty = analyze sample
                });
                const data = await response.json();

                if (data.error) {
                    showNotification('Error: ' + data.error, 'error');
                } else {
                    showNotification('Analyzed ' + data.analyzed + ' cameras. Refreshing results...', 'success');
                    setTimeout(loadAiAnalysis, 1000);
                }
            } catch (error) {
                showNotification('Error running batch analysis: ' + error.message, 'error');
            }
        }

        // Test all cameras
        async function testAllCameras() {
            try {
                showNotification('Starting health check for all cameras...', 'info');
                const response = await fetch('/api/cameras/test-all', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message + '\nResults will update shortly...', 'success');
                    // Reload health data after 5 seconds
                    setTimeout(loadHealthData, 5000);
                }
            } catch (error) {
                showNotification('Error starting health check', 'error');
            }
        }

        // Get health indicator HTML
        function getHealthIndicator(cameraName) {
            const health = healthData[cameraName];
            if (!health) {
                return '<span class="health-indicator health-unknown" title="Unknown status"></span>';
            }
            const statusClass = 'health-' + health.status;
            const title = health.status.charAt(0).toUpperCase() + health.status.slice(1) +
                          (health.last_check ? ' (checked ' + new Date(health.last_check).toLocaleString() + ')' : '');
            return `<span class="health-indicator ${statusClass}" title="${title}"></span>`;
        }

        // Display cameras
        function displayCameras(cameras) {
            const container = document.getElementById('cameraContainer');

            if (cameras.length === 0) {
                container.innerHTML = '<div class="no-results">No cameras found</div>';
                return;
            }

            container.innerHTML = '<div class="camera-grid">' + cameras.map(cam => {
                const healthIndicator = getHealthIndicator(cam.name);
                const snapshotUrl = `/static/snapshots/${cam.ip}.jpg?t=${Date.now()}`;
                const health = healthData[cam.name];
                let responseTimeInfo = '';
                if (health && (health.avg_ping_ms || health.avg_snapshot_ms)) {
                    const pingTime = health.avg_ping_ms ? `${Math.round(health.avg_ping_ms)}ms` : 'N/A';
                    const snapTime = health.avg_snapshot_ms ? `${Math.round(health.avg_snapshot_ms)}ms` : 'N/A';
                    responseTimeInfo = `<div class="camera-info">‚è±Ô∏è Ping: ${pingTime} | Snapshot: ${snapTime}</div>`;
                }
                return `
                <div class="camera-card ${selectedCameras.has(cam.id) ? 'selected' : ''}" id="card-${cam.id}">
                    <div class="camera-header">
                        <input type="checkbox" class="camera-checkbox"
                               ${selectedCameras.has(cam.id) ? 'checked' : ''}
                               onchange="toggleCamera('${cam.id}')" />
                        <div class="camera-name">${cam.name}${healthIndicator}</div>
                    </div>
                    <div class="camera-info">üìç ${cam.location}</div>
                    <div class="camera-info">üåê ${cam.ip}</div>
                    ${responseTimeInfo}
                    <div class="camera-snapshot" onclick="viewSnapshot('${cam.ip}', '${cam.name}')">
                        <img src="${snapshotUrl}" alt="${cam.name} snapshot"
                             onerror="this.parentElement.innerHTML='<div class=\\'snapshot-placeholder\\'>No snapshot available</div>'" />
                    </div>
                    <div class="camera-actions">
                        <button class="action-btn reboot" onclick="showRebootModal('${cam.id}')">üîÑ Reboot</button>
                        <button class="action-btn snapshot" onclick="snapshotSingle('${cam.id}')">üì∏ Snapshot</button>
                    </div>
                </div>
            `}).join('') + '</div>';

            updateSelectionCount();
        }

        // Toggle camera selection
        function toggleCamera(cameraId) {
            if (selectedCameras.has(cameraId)) {
                selectedCameras.delete(cameraId);
            } else {
                selectedCameras.add(cameraId);
            }
            updateSelectionCount();

            const card = document.getElementById('card-' + cameraId);
            if (card) {
                card.classList.toggle('selected', selectedCameras.has(cameraId));
            }
        }

        // Update selection count and buttons
        function updateSelectionCount() {
            const count = selectedCameras.size;
            document.getElementById('selectedCameras').textContent = count;
            document.getElementById('bulkRebootBtn').disabled = count === 0;
            document.getElementById('bulkSnapshotBtn').disabled = count === 0;
        }

        // Select/Deselect all
        function selectAll() {
            const displayed = document.querySelectorAll('.camera-card');
            displayed.forEach(card => {
                const id = card.id.replace('card-', '');
                selectedCameras.add(id);
                card.classList.add('selected');
                const checkbox = card.querySelector('.camera-checkbox');
                if (checkbox) checkbox.checked = true;
            });
            updateSelectionCount();
        }

        function deselectAll() {
            selectedCameras.clear();
            document.querySelectorAll('.camera-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('.camera-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            updateSelectionCount();
        }

        // Search cameras
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.length < 2) {
                filterCameras(currentFilter);
                return;
            }

            const filtered = allCameras.filter(cam =>
                cam.name.toLowerCase().includes(query) ||
                cam.ip.includes(query) ||
                cam.location.toLowerCase().includes(query)
            );
            displayCameras(filtered);
        });

        // Filter by highway
        function filterHighway(highway) {
            currentFilter = highway;
            healthFilter = 'all'; // Reset health filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayCameras(getFilteredCameras());
        }

        // Filter by health status
        function filterHealth(status) {
            healthFilter = status;
            currentFilter = 'all'; // Reset highway filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayCameras(getFilteredCameras());
        }

        // Get filtered cameras based on current filters
        function getFilteredCameras() {
            let filtered = allCameras;

            // Apply highway filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(cam => cam.location.includes(currentFilter));
            }

            // Apply health filter
            if (healthFilter !== 'all') {
                filtered = filtered.filter(cam => {
                    const health = healthData[cam.name];
                    if (!health) return healthFilter === 'unknown';

                    if (healthFilter === 'online') {
                        return health.status === 'online';
                    } else if (healthFilter === 'offline') {
                        return health.status === 'offline' || health.status === 'degraded';
                    } else if (healthFilter === 'problem') {
                        return health.consecutive_failures >= 3;
                    }
                    return true;
                });
            }

            return filtered;
        }

        function filterCameras(highway) {
            // Deprecated - kept for compatibility
            filterHighway(highway);
        }

        // Show reboot modal
        function showRebootModal(cameraId) {
            const camera = allCameras.find(c => c.id === cameraId);
            if (!camera) return;

            currentRebootCamera = camera;
            document.getElementById('rebootCameraName').textContent = camera.name;
            document.getElementById('rebootOperator').value = '';
            document.getElementById('rebootReason').value = '';
            document.getElementById('rebootModal').classList.add('show');
        }

        function closeRebootModal() {
            document.getElementById('rebootModal').classList.remove('show');
            currentRebootCamera = null;
        }

        // Confirm reboot
        async function confirmReboot() {
            const operator = document.getElementById('rebootOperator').value.trim();
            const reason = document.getElementById('rebootReason').value.trim();

            if (!operator || !reason) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (!currentRebootCamera) return;

            try {
                const response = await fetch('/api/camera/reboot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_ip: currentRebootCamera.ip,
                        camera_name: currentRebootCamera.name,
                        operator: operator,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    let message = `‚úì Camera ${currentRebootCamera.name} rebooted successfully!`;
                    if (result.ticket_id) {
                        message += `\n\nüé´ MIMS Ticket Created: #${result.ticket_id}`;
                    }
                    showNotification(message, 'success');
                } else {
                    let message = `‚úó Reboot failed: ${result.message || 'Unknown error'}`;
                    if (result.ticket_id) {
                        message += `\n\nüé´ MIMS Ticket Created: #${result.ticket_id}`;
                        message += `\n(Failure documented for maintenance team)`;
                    }
                    showNotification(message, 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }

            closeRebootModal();
        }

        // Bulk reboot
        async function bulkReboot() {
            if (selectedCameras.size === 0) return;

            const operator = prompt('Enter your name:');
            if (!operator) return;

            const reason = prompt('Enter reason for reboot:');
            if (!reason) return;

            let success = 0;
            let failed = 0;

            for (const cameraId of selectedCameras) {
                const camera = allCameras.find(c => c.id === cameraId);
                if (!camera) continue;

                try {
                    const response = await fetch('/api/camera/reboot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            camera_ip: camera.ip,
                            camera_name: camera.name,
                            operator: operator,
                            reason: reason
                        })
                    });

                    if (response.ok) success++;
                    else failed++;
                } catch (error) {
                    failed++;
                }
            }

            showNotification(`Bulk reboot complete: ${success} succeeded, ${failed} failed`, success > 0 ? 'success' : 'error');
            deselectAll();
        }

        // Single camera snapshot
        function snapshotSingle(cameraId) {
            selectedCameras.clear();
            selectedCameras.add(cameraId);
            updateSelectionCount();
            bulkSnapshot();
        }

        // Bulk snapshot
        function bulkSnapshot() {
            if (selectedCameras.size === 0) return;

            document.getElementById('snapshotCameraCount').textContent = selectedCameras.size;
            document.getElementById('snapshotOperator').value = '';
            document.getElementById('snapshotModal').classList.add('show');
        }

        function closeSnapshotModal() {
            document.getElementById('snapshotModal').classList.remove('show');
            document.getElementById('snapshotStartBtn').disabled = false;
        }

        function hideSnapshotProgress() {
            stopSnapshotProgress();
            document.getElementById('snapshotProgressFloat').classList.remove('show');
        }

        // Confirm snapshot
        async function confirmSnapshot() {
            const operator = document.getElementById('snapshotOperator').value.trim();
            const duration = parseInt(document.getElementById('snapshotDuration').value);
            const interval = parseInt(document.getElementById('snapshotInterval').value);
            const emailInput = document.getElementById('snapshotEmails').value.trim();

            if (!operator) {
                showNotification('Please enter operator name', 'error');
                return;
            }

            // Parse email addresses
            const emailAddresses = emailInput ? emailInput.split(',').map(e => e.trim()).filter(e => e) : [];

            const cameras = Array.from(selectedCameras).map(id => {
                const cam = allCameras.find(c => c.id === id);
                return { ip: cam.ip, name: cam.name };
            });

            try {
                const payload = {
                    cameras: cameras,
                    duration_minutes: duration,
                    interval_seconds: interval,
                    operator: operator,
                    output_format: 'shared_folder'
                };

                // Add email settings if addresses provided
                if (emailAddresses.length > 0) {
                    payload.email_report = true;
                    payload.email_recipients = emailAddresses;
                }

                const response = await fetch('/api/snapshot/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    currentSnapshotSession = result.session_id || Date.now().toString();
                    showNotification(`Snapshot capture started! Progress shown in bottom-right corner.`, 'success');

                    // Close modal and show floating progress
                    closeSnapshotModal();
                    document.getElementById('snapshotProgressFloat').classList.add('show');
                    updateSnapshotProgress(0, duration, 0, 0, cameras.length);
                    startSnapshotProgress(duration, cameras.length);
                } else {
                    showNotification(`Snapshot failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }

            deselectAll();
        }

        // Start snapshot progress tracking
        function startSnapshotProgress(durationMinutes, cameraCount) {
            const startTime = Date.now();
            const endTime = startTime + (durationMinutes * 60 * 1000);

            snapshotProgressInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = now - startTime;
                const total = endTime - startTime;
                const progress = Math.min(100, (elapsed / total) * 100);
                const elapsedMinutes = Math.floor(elapsed / 60000);
                const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);

                updateSnapshotProgress(progress, durationMinutes, elapsedMinutes, elapsedSeconds, cameraCount);

                if (progress >= 100) {
                    stopSnapshotProgress();
                    showNotification('Snapshot capture complete! Check shared folder for results.', 'success');
                    setTimeout(() => hideSnapshotProgress(), 3000);
                }
            }, 1000);
        }

        // Stop snapshot progress tracking
        function stopSnapshotProgress() {
            if (snapshotProgressInterval) {
                clearInterval(snapshotProgressInterval);
                snapshotProgressInterval = null;
            }
        }

        // Update snapshot progress display
        function updateSnapshotProgress(percent, totalMinutes, elapsedMin, elapsedSec, cameraCount) {
            const progressBar = document.getElementById('snapshotProgressBar');
            const progressText = document.getElementById('snapshotProgressText');
            const progressDetails = document.getElementById('snapshotProgressDetails');

            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.floor(percent) + '%';
            progressText.textContent = Math.floor(percent) + '%';

            const remainingMin = totalMinutes - elapsedMin;
            const remainingDisplay = remainingMin > 0 ? `${remainingMin} min remaining` : 'Finishing...';
            progressDetails.textContent = `${cameraCount} camera(s) ‚Ä¢ ${elapsedMin}m ${elapsedSec}s elapsed ‚Ä¢ ${remainingDisplay}`;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // View snapshot in modal
        function viewSnapshot(ip, cameraName) {
            const modal = document.getElementById('snapshotModal');
            const modalImg = document.getElementById('snapshotModalImg');
            const caption = document.getElementById('snapshotCaption');

            modal.style.display = 'block';
            modalImg.src = `/static/snapshots/${ip}.jpg?t=${Date.now()}`;
            caption.textContent = `${cameraName} (${ip})`;
        }

        function closeSnapshotModal() {
            document.getElementById('snapshotModal').style.display = 'none';
        }

        // Close modal on click outside image
        window.onclick = function(event) {
            const modal = document.getElementById('snapshotModal');
            if (event.target == modal) {
                closeSnapshotModal();
            }
        }

        // ===================================================================
        // GROUP MANAGEMENT FUNCTIONS
        // ===================================================================

        let allGroups = [];
        let currentGroupId = null;
        let currentGroupEdit = null;

        // Switch between tabs
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            const camerasSection = document.querySelector('.toolbar');
            const groupsSection = document.getElementById('groupsSection');
            const maintenanceSection = document.getElementById('maintenanceSection');
            const slaSection = document.getElementById('slaSection');
            const alertsSection = document.getElementById('alertsSection');
            const aiSection = document.getElementById('aiAnalysisSection');
            const trendsSection = document.getElementById('trendsSection');
            const cameraContainer = document.getElementById('cameraContainer');

            if (tab === 'groups') {
                // Show groups, hide others
                camerasSection.style.display = 'none';
                cameraContainer.style.display = 'none';
                aiSection.style.display = 'none';
                trendsSection.style.display = 'none';
                maintenanceSection.style.display = 'none';
                slaSection.style.display = 'none';
                alertsSection.style.display = 'none';
                groupsSection.style.display = 'block';
                loadGroups();
            } else if (tab === 'maintenance') {
                // Show maintenance, hide others
                camerasSection.style.display = 'none';
                cameraContainer.style.display = 'none';
                aiSection.style.display = 'none';
                trendsSection.style.display = 'none';
                groupsSection.style.display = 'none';
                slaSection.style.display = 'none';
                alertsSection.style.display = 'none';
                maintenanceSection.style.display = 'block';
                loadMaintenanceData();
            } else if (tab === 'sla') {
                // Show SLA, hide others
                camerasSection.style.display = 'none';
                cameraContainer.style.display = 'none';
                aiSection.style.display = 'none';
                trendsSection.style.display = 'none';
                groupsSection.style.display = 'none';
                maintenanceSection.style.display = 'none';
                alertsSection.style.display = 'none';
                slaSection.style.display = 'block';
                loadSlaData();
            } else if (tab === 'alerts') {
                // Show alerts, hide others
                camerasSection.style.display = 'none';
                cameraContainer.style.display = 'none';
                aiSection.style.display = 'none';
                trendsSection.style.display = 'none';
                groupsSection.style.display = 'none';
                maintenanceSection.style.display = 'none';
                slaSection.style.display = 'none';
                alertsSection.style.display = 'block';
                loadAlertsData();
            } else {
                // Show cameras, hide others
                camerasSection.style.display = 'block';
                cameraContainer.style.display = 'block';
                aiSection.style.display = 'block';
                trendsSection.style.display = 'block';
                groupsSection.style.display = 'none';
                maintenanceSection.style.display = 'none';
                slaSection.style.display = 'none';
                alertsSection.style.display = 'none';
            }
        }

        // Load all groups
        async function loadGroups() {
            const container = document.getElementById('groupsContainer');
            container.innerHTML = '<div class="loading">Loading groups...</div>';

            try {
                const response = await fetch('/api/groups/db/list');
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = '<div class="no-results">Failed to load groups</div>';
                    return;
                }

                // Get groups from database
                allGroups = data.groups || [];

                if (allGroups.length === 0) {
                    container.innerHTML = '<div class="no-results">No groups created yet. Click "Create Group" to get started.</div>';
                    return;
                }

                renderGroups(allGroups);
            } catch (error) {
                console.error('Error loading groups:', error);
                container.innerHTML = '<div class="no-results">Error loading groups</div>';
            }
        }

        // Render groups
        function renderGroups(groups) {
            const container = document.getElementById('groupsContainer');

            if (groups.length === 0) {
                container.innerHTML = '<div class="no-results">No groups match your search</div>';
                return;
            }

            container.innerHTML = groups.map(group => `
                <div class="group-card" data-group-id="${group.id}">
                    <div class="group-header">
                        <div>
                            <div class="group-name">${escapeHtml(group.group_name)}</div>
                            <span class="group-type-badge badge-${group.group_type}">${group.group_type}</span>
                        </div>
                    </div>
                    ${group.description ? `<div class="group-description">${escapeHtml(group.description)}</div>` : ''}
                    <div class="group-stats">
                        <div class="group-stat-item">
                            <span>üìπ</span>
                            <span>${group.member_count || 0} cameras</span>
                        </div>
                        <div class="group-stat-item">
                            <span>üìÖ</span>
                            <span>Created ${formatDate(group.created_at)}</span>
                        </div>
                    </div>
                    <div class="group-actions">
                        <button class="btn btn-secondary" onclick="viewGroup(${group.id})">View Details</button>
                        <button class="btn btn-success" onclick="openAddCamerasModal(${group.id}, '${escapeHtml(group.group_name)}')">+ Add Cameras</button>
                        <button class="btn btn-secondary" onclick="editGroup(${group.id})">Edit</button>
                        <button class="btn btn-danger" onclick="deleteGroup(${group.id}, '${escapeHtml(group.group_name)}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Search groups
        function searchGroups() {
            const searchTerm = document.getElementById('groupSearchInput').value.toLowerCase();
            const filtered = allGroups.filter(group =>
                group.group_name.toLowerCase().includes(searchTerm) ||
                group.group_type.toLowerCase().includes(searchTerm) ||
                (group.description && group.description.toLowerCase().includes(searchTerm))
            );
            renderGroups(filtered);
        }

        // Open create group modal
        function openCreateGroupModal() {
            currentGroupEdit = null;
            document.getElementById('groupModalTitle').textContent = 'Create Group';
            document.getElementById('groupName').value = '';
            document.getElementById('groupType').value = 'custom';
            document.getElementById('groupDescription').value = '';
            document.getElementById('saveGroupBtn').textContent = 'Create Group';
            document.getElementById('groupModal').classList.add('show');
        }

        // Close group modal
        function closeGroupModal() {
            document.getElementById('groupModal').classList.remove('show');
        }

        // Save group (create or update)
        async function saveGroup() {
            const name = document.getElementById('groupName').value.trim();
            const type = document.getElementById('groupType').value;
            const description = document.getElementById('groupDescription').value.trim();

            if (!name) {
                showNotification('Please enter a group name', 'error');
                return;
            }

            const data = {
                group_name: name,
                group_type: type,
                description: description
            };

            try {
                let response;
                if (currentGroupEdit) {
                    // Update existing group
                    response = await fetch(`/api/groups/${currentGroupEdit}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                } else {
                    // Create new group
                    response = await fetch('/api/groups/create', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(data)
                    });
                }

                const result = await response.json();

                if (result.success) {
                    showNotification(currentGroupEdit ? 'Group updated successfully' : 'Group created successfully', 'success');
                    closeGroupModal();
                    loadGroups();
                } else {
                    showNotification(result.error || 'Failed to save group', 'error');
                }
            } catch (error) {
                console.error('Error saving group:', error);
                showNotification('Error saving group', 'error');
            }
        }

        // Edit group
        async function editGroup(groupId) {
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                const data = await response.json();

                if (data.success) {
                    currentGroupEdit = groupId;
                    document.getElementById('groupModalTitle').textContent = 'Edit Group';
                    document.getElementById('groupName').value = data.group.group_name;
                    document.getElementById('groupType').value = data.group.group_type;
                    document.getElementById('groupDescription').value = data.group.description || '';
                    document.getElementById('saveGroupBtn').textContent = 'Update Group';
                    document.getElementById('groupModal').classList.add('show');
                } else {
                    showNotification('Failed to load group details', 'error');
                }
            } catch (error) {
                console.error('Error loading group:', error);
                showNotification('Error loading group details', 'error');
            }
        }

        // Delete group
        async function deleteGroup(groupId, groupName) {
            if (!confirm(`Are you sure you want to delete the group "${groupName}"? This action cannot be undone.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/groups/${groupId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Group deleted successfully', 'success');
                    loadGroups();
                } else {
                    showNotification(result.error || 'Failed to delete group', 'error');
                }
            } catch (error) {
                console.error('Error deleting group:', error);
                showNotification('Error deleting group', 'error');
            }
        }

        // View group details
        async function viewGroup(groupId) {
            try {
                const response = await fetch(`/api/groups/${groupId}`);
                const data = await response.json();

                if (data.success) {
                    currentGroupId = groupId;
                    const group = data.group;

                    document.getElementById('viewGroupName').textContent = group.group_name;
                    document.getElementById('viewGroupTypeBadge').textContent = group.group_type;
                    document.getElementById('viewGroupTypeBadge').className = `group-type-badge badge-${group.group_type}`;
                    document.getElementById('viewGroupDescription').textContent = group.description || 'No description';
                    document.getElementById('viewGroupMemberCount').textContent = `${group.member_count || 0} cameras`;
                    document.getElementById('viewGroupCreated').textContent = `Created ${formatDate(group.created_at)}`;

                    // Render members
                    const membersList = document.getElementById('viewGroupMembers');
                    if (group.members && group.members.length > 0) {
                        membersList.innerHTML = group.members.map(member => `
                            <div class="member-item">
                                <span class="member-name">${escapeHtml(member.camera_name)}</span>
                                <span class="member-remove-btn" onclick="removeCameraFromGroup('${escapeHtml(member.camera_name)}')" title="Remove">√ó</span>
                            </div>
                        `).join('');
                    } else {
                        membersList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No cameras in this group</div>';
                    }

                    document.getElementById('viewGroupModal').classList.add('show');
                } else {
                    showNotification('Failed to load group details', 'error');
                }
            } catch (error) {
                console.error('Error loading group:', error);
                showNotification('Error loading group details', 'error');
            }
        }

        // Close view group modal
        function closeViewGroupModal() {
            document.getElementById('viewGroupModal').classList.remove('show');
            currentGroupId = null;
        }

        // Open edit from view modal
        function openEditGroupModal() {
            closeViewGroupModal();
            editGroup(currentGroupId);
        }

        // Delete group from view modal
        function deleteGroupConfirm() {
            const groupName = document.getElementById('viewGroupName').textContent;
            closeViewGroupModal();
            deleteGroup(currentGroupId, groupName);
        }

        // Open add cameras modal
        async function openAddCamerasModal(groupId, groupName) {
            currentGroupId = groupId;
            document.getElementById('addCamerasGroupName').textContent = groupName;

            // Load all cameras
            const container = document.getElementById('cameraSelector');
            container.innerHTML = '<div class="loading">Loading cameras...</div>';

            try {
                const cameras = allCameras.length > 0 ? allCameras : Object.keys(await loadCamerasData());
                container.innerHTML = cameras.map((camera, index) => {
                    const cameraName = typeof camera === 'string' ? camera : camera.name;
                    return `
                        <div class="camera-selector-item" data-camera="${escapeHtml(cameraName)}">
                            <input type="checkbox" id="cam_${index}" value="${escapeHtml(cameraName)}" />
                            <label for="cam_${index}" style="cursor: pointer; flex: 1;">${escapeHtml(cameraName)}</label>
                        </div>
                    `;
                }).join('');

                document.getElementById('addCamerasModal').classList.add('show');
            } catch (error) {
                console.error('Error loading cameras:', error);
                container.innerHTML = '<div class="no-results">Error loading cameras</div>';
            }
        }

        // Open add cameras from view modal
        function openAddCamerasFromView() {
            const groupName = document.getElementById('viewGroupName').textContent;
            openAddCamerasModal(currentGroupId, groupName);
        }

        // Close add cameras modal
        function closeAddCamerasModal() {
            document.getElementById('addCamerasModal').classList.remove('show');
        }

        // Filter camera selector
        function filterCameraSelector() {
            const search = document.getElementById('cameraSearch').value.toLowerCase();
            const items = document.querySelectorAll('.camera-selector-item');

            items.forEach(item => {
                const cameraName = item.dataset.camera.toLowerCase();
                item.style.display = cameraName.includes(search) ? 'flex' : 'none';
            });
        }

        // Confirm add cameras
        async function confirmAddCameras() {
            const checkboxes = document.querySelectorAll('#cameraSelector input[type="checkbox"]:checked');
            const cameras = Array.from(checkboxes).map(cb => cb.value);

            if (cameras.length === 0) {
                showNotification('Please select at least one camera', 'error');
                return;
            }

            try {
                const response = await fetch(`/api/groups/${currentGroupId}/members`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cameras: cameras})
                });

                const result = await response.json();

                if (result.success) {
                    showNotification(`Added ${result.added} camera(s) to group`, 'success');
                    closeAddCamerasModal();
                    loadGroups();
                    // If view modal was open, refresh it
                    if (document.getElementById('viewGroupModal').classList.contains('show')) {
                        viewGroup(currentGroupId);
                    }
                } else {
                    showNotification(result.error || 'Failed to add cameras', 'error');
                }
            } catch (error) {
                console.error('Error adding cameras:', error);
                showNotification('Error adding cameras to group', 'error');
            }
        }

        // Remove camera from group
        async function removeCameraFromGroup(cameraName) {
            if (!confirm(`Remove ${cameraName} from this group?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/groups/${currentGroupId}/members`, {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({cameras: [cameraName]})
                });

                const result = await response.json();

                if (result.success) {
                    showNotification('Camera removed from group', 'success');
                    viewGroup(currentGroupId); // Refresh view
                    loadGroups(); // Refresh list
                } else {
                    showNotification(result.error || 'Failed to remove camera', 'error');
                }
            } catch (error) {
                console.error('Error removing camera:', error);
                showNotification('Error removing camera from group', 'error');
            }
        }

        // Helper: Load cameras data
        async function loadCamerasData() {
            const response = await fetch('/api/cameras/health');
            const data = await response.json();
            return data.cameras || {};
        }

        // Helper: Format date
        function formatDate(dateString) {
            if (!dateString) return 'Unknown';
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        // Helper: Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ==========================================================================
        // MAINTENANCE & DOWNTIME MANAGEMENT
        // ==========================================================================

        let allMaintenanceWindows = [];
        let currentEditWindowId = null;

        // Load all maintenance data
        async function loadMaintenanceData() {
            await Promise.all([
                loadDowntimeSummary(),
                loadMaintenanceWindows(),
                loadTopDowntimeCameras()
            ]);
        }

        // Load downtime summary stats
        async function loadDowntimeSummary() {
            try {
                const response = await fetch('/api/downtime/summary?days=30');
                const data = await response.json();

                if (data.success) {
                    const summary = data.summary;
                    document.getElementById('currentlyDown').textContent = summary.currently_down;
                    document.getElementById('totalIncidents').textContent = summary.total_incidents;
                    document.getElementById('totalDowntimeHours').textContent = summary.total_downtime_hours.toFixed(1);
                    document.getElementById('avgDowntime').textContent = summary.avg_downtime_minutes.toFixed(0);
                }
            } catch (error) {
                console.error('Error loading downtime summary:', error);
            }
        }

        // Load maintenance windows
        async function loadMaintenanceWindows() {
            const container = document.getElementById('maintenanceWindowsContainer');
            container.innerHTML = '<div class="loading">Loading maintenance windows...</div>';

            try {
                const response = await fetch('/api/maintenance/list?days_ahead=30&days_back=7');
                const data = await response.json();

                if (!data.success) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">Failed to load maintenance windows</div>';
                    return;
                }

                allMaintenanceWindows = data.windows || [];

                if (allMaintenanceWindows.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No maintenance windows scheduled. Click "Schedule Maintenance" to create one.</div>';
                    return;
                }

                // Render maintenance windows
                container.innerHTML = allMaintenanceWindows.map(window => {
                    const statusColors = {
                        'scheduled': '#1565c0',
                        'in-progress': '#f57c00',
                        'completed': '#2e7d32',
                        'cancelled': '#c62828'
                    };

                    const startDate = new Date(window.scheduled_start);
                    const endDate = new Date(window.scheduled_end);
                    const duration = Math.round((endDate - startDate) / (1000 * 60));

                    return `
                        <div style="padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div style="flex: 1;">
                                <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                    <strong style="color: #003366;">${escapeHtml(window.camera_name)}</strong>
                                    <span style="background: ${statusColors[window.status]}; color: white; padding: 2px 8px; border-radius: 3px; font-size: 11px; text-transform: uppercase;">${window.status}</span>
                                    <span style="background: #e0e0e0; color: #666; padding: 2px 8px; border-radius: 3px; font-size: 11px;">${window.maintenance_type}</span>
                                </div>
                                <div style="color: #666; font-size: 13px;">
                                    üìÖ ${formatDate(window.scheduled_start)} - ${formatDate(window.scheduled_end)} (${duration} min)
                                </div>
                                ${window.description ? `<div style="color: #999; font-size: 12px; margin-top: 3px;">${escapeHtml(window.description)}</div>` : ''}
                                ${window.technician ? `<div style="color: #999; font-size: 12px;">üë§ ${escapeHtml(window.technician)}</div>` : ''}
                            </div>
                            <div style="display: flex; gap: 8px;">
                                ${window.status === 'scheduled' ? `
                                    <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 12px;" onclick="editMaintenanceWindow(${window.id})">Edit</button>
                                    <button class="btn btn-danger" style="padding: 4px 10px; font-size: 12px;" onclick="deleteMaintenanceWindow(${window.id}, '${escapeHtml(window.camera_name)}')">Cancel</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading maintenance windows:', error);
                container.innerHTML = '<div style="text-align: center; color: #c62828; padding: 20px;">Error loading maintenance windows</div>';
            }
        }

        // Load top cameras by downtime
        async function loadTopDowntimeCameras() {
            const container = document.getElementById('topDowntimeCameras');
            container.innerHTML = '<div class="loading">Loading...</div>';

            try {
                const response = await fetch('/api/downtime/summary?days=30');
                const data = await response.json();

                if (!data.success || !data.top_cameras || data.top_cameras.length === 0) {
                    container.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">No downtime data available</div>';
                    return;
                }

                container.innerHTML = data.top_cameras.map(camera => {
                    const hoursDown = (camera.total_downtime_minutes / 60).toFixed(1);
                    return `
                        <div style="padding: 12px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="font-weight: 500; color: #003366;">${escapeHtml(camera.camera_name)}</div>
                                <div style="color: #999; font-size: 12px;">
                                    ${camera.incident_count} incident${camera.incident_count !== 1 ? 's' : ''}
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 18px; font-weight: 500; color: #f57c00;">${hoursDown}h</div>
                                <div style="color: #999; font-size: 11px;">${camera.total_downtime_minutes} min</div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading top downtime cameras:', error);
                container.innerHTML = '<div style="text-align: center; color: #c62828; padding: 20px;">Error loading data</div>';
            }
        }

        // Open schedule maintenance modal
        async function openScheduleMaintenanceModal() {
            currentEditWindowId = null;
            document.getElementById('maintenanceModalTitle').textContent = 'Schedule Maintenance';

            // Reset form
            document.getElementById('maintenanceCameraSelect').value = '';
            document.getElementById('maintenanceType').value = 'planned';
            document.getElementById('maintenanceStart').value = '';
            document.getElementById('maintenanceEnd').value = '';
            document.getElementById('maintenanceDescription').value = '';
            document.getElementById('maintenanceTechnician').value = '';
            document.getElementById('maintenanceVendor').value = '';
            document.getElementById('maintenanceSuppressAlerts').checked = true;

            // Populate camera dropdown
            const select = document.getElementById('maintenanceCameraSelect');
            select.innerHTML = '<option value="">Select camera...</option>';

            const sortedCameras = Object.entries(allCameras).map(([id, cam]) => ({
                id,
                name: cam.name || id
            })).sort((a, b) => a.name.localeCompare(b.name));

            sortedCameras.forEach(cam => {
                const option = document.createElement('option');
                option.value = cam.name;
                option.textContent = cam.name;
                select.appendChild(option);
            });

            document.getElementById('maintenanceModal').style.display = 'block';
        }

        // Edit maintenance window
        async function editMaintenanceWindow(windowId) {
            try {
                const response = await fetch(`/api/maintenance/${windowId}`);
                const data = await response.json();

                if (!data.success) {
                    showNotification('Failed to load maintenance window', 'error');
                    return;
                }

                const window = data.window;
                currentEditWindowId = windowId;

                document.getElementById('maintenanceModalTitle').textContent = 'Edit Maintenance Window';
                document.getElementById('maintenanceCameraSelect').value = window.camera_name;
                document.getElementById('maintenanceType').value = window.maintenance_type;

                // Convert ISO datetime to local datetime-local format
                const startDate = new Date(window.scheduled_start);
                const endDate = new Date(window.scheduled_end);
                document.getElementById('maintenanceStart').value = formatDateTimeLocal(startDate);
                document.getElementById('maintenanceEnd').value = formatDateTimeLocal(endDate);

                document.getElementById('maintenanceDescription').value = window.description || '';
                document.getElementById('maintenanceTechnician').value = window.technician || '';
                document.getElementById('maintenanceVendor').value = window.vendor || '';
                document.getElementById('maintenanceSuppressAlerts').checked = window.suppress_alerts;

                document.getElementById('maintenanceModal').style.display = 'block';

            } catch (error) {
                console.error('Error loading maintenance window:', error);
                showNotification('Error loading maintenance window', 'error');
            }
        }

        // Save maintenance window (create or update)
        async function saveMaintenanceWindow() {
            const cameraName = document.getElementById('maintenanceCameraSelect').value;
            const maintenanceType = document.getElementById('maintenanceType').value;
            const scheduledStart = document.getElementById('maintenanceStart').value;
            const scheduledEnd = document.getElementById('maintenanceEnd').value;
            const description = document.getElementById('maintenanceDescription').value;
            const technician = document.getElementById('maintenanceTechnician').value;
            const vendor = document.getElementById('maintenanceVendor').value;
            const suppressAlerts = document.getElementById('maintenanceSuppressAlerts').checked;

            // Validation
            if (!cameraName || !scheduledStart || !scheduledEnd) {
                showNotification('Please fill in all required fields', 'error');
                return;
            }

            if (new Date(scheduledEnd) <= new Date(scheduledStart)) {
                showNotification('End time must be after start time', 'error');
                return;
            }

            try {
                const payload = {
                    camera_name: cameraName,
                    maintenance_type: maintenanceType,
                    scheduled_start: new Date(scheduledStart).toISOString(),
                    scheduled_end: new Date(scheduledEnd).toISOString(),
                    description,
                    technician,
                    vendor,
                    suppress_alerts: suppressAlerts,
                    created_by: 'dashboard'
                };

                let response;
                if (currentEditWindowId) {
                    // Update existing
                    response = await fetch(`/api/maintenance/${currentEditWindowId}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                } else {
                    // Create new
                    response = await fetch('/api/maintenance/create', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                }

                const data = await response.json();

                if (data.success) {
                    showNotification(currentEditWindowId ? 'Maintenance window updated successfully' : 'Maintenance window scheduled successfully', 'success');
                    closeMaintenanceModal();
                    loadMaintenanceWindows();
                } else {
                    showNotification(data.error || 'Failed to save maintenance window', 'error');
                }

            } catch (error) {
                console.error('Error saving maintenance window:', error);
                showNotification('Error saving maintenance window', 'error');
            }
        }

        // Delete maintenance window
        async function deleteMaintenanceWindow(windowId, cameraName) {
            if (!confirm(`Cancel maintenance window for ${cameraName}?`)) {
                return;
            }

            try {
                const response = await fetch(`/api/maintenance/${windowId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Maintenance window cancelled', 'success');
                    loadMaintenanceWindows();
                } else {
                    showNotification(data.error || 'Failed to cancel maintenance window', 'error');
                }

            } catch (error) {
                console.error('Error deleting maintenance window:', error);
                showNotification('Error cancelling maintenance window', 'error');
            }
        }

        // Close maintenance modal
        function closeMaintenanceModal() {
            document.getElementById('maintenanceModal').style.display = 'none';
            currentEditWindowId = null;
        }

        // Helper: Format datetime for datetime-local input
        function formatDateTimeLocal(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // ============================================================================
        // SLA COMPLIANCE FUNCTIONS
        // ============================================================================

        // Load all SLA data
        async function loadSlaData() {
            await Promise.all([
                loadSlaSummary(),
                loadSlaViolations(),
                loadSlaTargetBreakdown(),
                loadMonthlyComplianceReport()
            ]);
        }

        // Load SLA summary statistics
        async function loadSlaSummary() {
            const days = document.getElementById('slaPeriodSelect').value;

            try {
                const response = await fetch(`/api/sla/summary?days=${days}`);
                const data = await response.json();

                if (data.success && data.summaries) {
                    // Update summary cards
                    const standardSummary = data.summaries.find(s => s.target_name === 'Standard');
                    const premiumSummary = data.summaries.find(s => s.target_name === 'Premium');
                    const criticalSummary = data.summaries.find(s => s.target_name === 'Critical');

                    document.getElementById('slaStandardCompliance').textContent =
                        standardSummary ? `${standardSummary.compliance_rate.toFixed(1)}%` : '-';
                    document.getElementById('slaPremiumCompliance').textContent =
                        premiumSummary ? `${premiumSummary.compliance_rate.toFixed(1)}%` : '-';
                    document.getElementById('slaCriticalCompliance').textContent =
                        criticalSummary ? `${criticalSummary.compliance_rate.toFixed(1)}%` : '-';

                    // Calculate total violations
                    const totalViolations = data.summaries.reduce((sum, s) => sum + s.failing_sla, 0);
                    document.getElementById('slaViolationsCount').textContent = totalViolations;
                }

            } catch (error) {
                console.error('Error loading SLA summary:', error);
            }
        }

        // Load SLA violations and at-risk cameras
        async function loadSlaViolations() {
            const days = document.getElementById('slaPeriodSelect').value;
            const container = document.getElementById('slaViolationsContainer');

            try {
                const response = await fetch(`/api/sla/violations?days=${days}&threshold=5`);
                const data = await response.json();

                if (data.success) {
                    const failing = data.failing || [];
                    const atRisk = data.at_risk || [];

                    if (failing.length === 0 && atRisk.length === 0) {
                        container.innerHTML = '<p style="color: #2e7d32; font-weight: 600;">‚úì All cameras meeting SLA targets</p>';
                        return;
                    }

                    let html = '';

                    // Failing cameras
                    if (failing.length > 0) {
                        html += '<div style="margin-bottom: 20px;"><h4 style="color: #d32f2f; margin: 0 0 10px 0;">üö® Failing SLA (' + failing.length + ')</h4>';
                        html += '<div style="display: grid; gap: 10px;">';
                        failing.forEach(cam => {
                            const uptimeColor = cam.uptime_percentage < 90 ? '#d32f2f' : '#f57c00';
                            html += `
                                <div style="background: #fff3e0; padding: 12px; border-radius: 6px; border-left: 4px solid #d32f2f;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong style="color: #003366;">${cam.camera_name}</strong><br>
                                            <span style="font-size: 12px; color: #666;">Target: ${cam.sla_target}% | Actual: <span style="color: ${uptimeColor}; font-weight: 600;">${cam.uptime_percentage.toFixed(2)}%</span></span>
                                        </div>
                                        <div style="text-align: right; font-size: 12px;">
                                            <div style="color: #d32f2f; font-weight: 600;">${cam.downtime_minutes} min down</div>
                                            <div style="color: #666;">Last ${days} days</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div></div>';
                    }

                    // At-risk cameras
                    if (atRisk.length > 0) {
                        html += '<div><h4 style="color: #f57c00; margin: 0 0 10px 0;">‚ö†Ô∏è At Risk (' + atRisk.length + ')</h4>';
                        html += '<div style="display: grid; gap: 10px;">';
                        atRisk.forEach(cam => {
                            html += `
                                <div style="background: #fff8e1; padding: 12px; border-radius: 6px; border-left: 4px solid #f57c00;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div>
                                            <strong style="color: #003366;">${cam.camera_name}</strong><br>
                                            <span style="font-size: 12px; color: #666;">Target: ${cam.sla_target}% | Actual: <span style="color: #f57c00; font-weight: 600;">${cam.uptime_percentage.toFixed(2)}%</span></span>
                                        </div>
                                        <div style="text-align: right; font-size: 12px;">
                                            <div style="color: #f57c00; font-weight: 600;">${cam.downtime_minutes} min down</div>
                                            <div style="color: #666;">Last ${days} days</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        html += '</div></div>';
                    }

                    container.innerHTML = html;
                }

            } catch (error) {
                console.error('Error loading SLA violations:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading violations</p>';
            }
        }

        // Load SLA target breakdown
        async function loadSlaTargetBreakdown() {
            const days = document.getElementById('slaPeriodSelect').value;
            const container = document.getElementById('slaTargetBreakdown');

            try {
                const response = await fetch(`/api/sla/summary?days=${days}`);
                const data = await response.json();

                if (data.success && data.summaries) {
                    let html = '<div style="display: grid; gap: 15px;">';

                    data.summaries.forEach(summary => {
                        const complianceRate = summary.compliance_rate;
                        const barColor = complianceRate >= 95 ? '#4caf50' : complianceRate >= 85 ? '#ff9800' : '#f44336';

                        html += `
                            <div style="padding: 15px; border: 1px solid #ddd; border-radius: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div>
                                        <strong style="color: #003366; font-size: 16px;">${summary.target_name} (${summary.target_percentage}%)</strong>
                                    </div>
                                    <div style="text-align: right;">
                                        <span style="font-size: 20px; font-weight: bold; color: ${barColor};">${complianceRate.toFixed(1)}%</span>
                                    </div>
                                </div>
                                <div style="background: #f0f0f0; height: 24px; border-radius: 12px; overflow: hidden; margin-bottom: 8px;">
                                    <div style="background: ${barColor}; height: 100%; width: ${complianceRate}%; transition: width 0.3s;"></div>
                                </div>
                                <div style="display: flex; justify-content: space-between; font-size: 13px; color: #666;">
                                    <span>‚úì Meeting: <strong style="color: #4caf50;">${summary.meeting_sla}</strong></span>
                                    <span>‚úó Failing: <strong style="color: #f44336;">${summary.failing_sla}</strong></span>
                                    <span>Total: <strong>${summary.total_cameras}</strong></span>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                }

            } catch (error) {
                console.error('Error loading SLA target breakdown:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading target breakdown</p>';
            }
        }

        // Load monthly compliance report
        async function loadMonthlyComplianceReport() {
            const container = document.getElementById('monthlyComplianceReport');

            try {
                const response = await fetch('/api/sla/monthly-report');
                const data = await response.json();

                if (data.success && data.report && data.report.length > 0) {
                    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                    html += `
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 12px; text-align: left;">Camera</th>
                                <th style="padding: 12px; text-align: center;">Month</th>
                                <th style="padding: 12px; text-align: center;">Uptime %</th>
                                <th style="padding: 12px; text-align: center;">Downtime (min)</th>
                                <th style="padding: 12px; text-align: center;">Incidents</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    data.report.slice(0, 20).forEach((row, idx) => {
                        const bgColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';
                        const uptimeColor = row.uptime_percentage >= 99.9 ? '#4caf50' :
                                           row.uptime_percentage >= 99 ? '#8bc34a' :
                                           row.uptime_percentage >= 95 ? '#ff9800' : '#f44336';
                        const statusIcon = row.uptime_percentage >= 95 ? '‚úì' : '‚úó';
                        const statusColor = row.uptime_percentage >= 95 ? '#4caf50' : '#f44336';

                        html += `
                            <tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">
                                <td style="padding: 10px;"><strong>${row.camera_name}</strong></td>
                                <td style="padding: 10px; text-align: center;">${row.month_year}</td>
                                <td style="padding: 10px; text-align: center; color: ${uptimeColor}; font-weight: 600;">${row.uptime_percentage.toFixed(2)}%</td>
                                <td style="padding: 10px; text-align: center;">${row.total_downtime_minutes}</td>
                                <td style="padding: 10px; text-align: center;">${row.incident_count}</td>
                                <td style="padding: 10px; text-align: center; color: ${statusColor}; font-weight: 600;">${statusIcon}</td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';

                    if (data.report.length > 20) {
                        html += `<p style="text-align: center; margin-top: 10px; color: #666; font-size: 13px;">Showing first 20 of ${data.report.length} entries</p>`;
                    }

                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<p style="color: #666;">No monthly compliance data available</p>';
                }

            } catch (error) {
                console.error('Error loading monthly compliance report:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading monthly report</p>';
            }
        }

        // ============================================================================
        // ALERTS MANAGEMENT FUNCTIONS
        // ============================================================================

        // Switch between alert sub-tabs
        function switchAlertsTab(tab) {
            // Update tab buttons
            document.getElementById('activeAlertsTab').classList.remove('active');
            document.getElementById('alertRulesTab').classList.remove('active');
            document.getElementById('alertHistoryTab').classList.remove('active');

            // Update views
            document.getElementById('activeAlertsView').style.display = 'none';
            document.getElementById('alertRulesView').style.display = 'none';
            document.getElementById('alertHistoryView').style.display = 'none';

            if (tab === 'active') {
                document.getElementById('activeAlertsTab').classList.add('active');
                document.getElementById('activeAlertsView').style.display = 'block';
                loadActiveAlerts();
            } else if (tab === 'rules') {
                document.getElementById('alertRulesTab').classList.add('active');
                document.getElementById('alertRulesView').style.display = 'block';
                loadAlertRules();
            } else if (tab === 'history') {
                document.getElementById('alertHistoryTab').classList.add('active');
                document.getElementById('alertHistoryView').style.display = 'block';
                loadAlertHistory();
            }
        }

        // Load all alerts data
        async function loadAlertsData() {
            await Promise.all([
                loadAlertStatistics(),
                loadActiveAlerts()
            ]);
        }

        // Load alert statistics
        async function loadAlertStatistics() {
            try {
                const response = await fetch('/api/alerts/statistics?days=30');
                const data = await response.json();

                if (data.success) {
                    document.getElementById('activeAlertsCount').textContent = data.totals.active_alerts;
                    document.getElementById('totalAlertsCount').textContent = data.totals.total_alerts;

                    // Get alert rules count
                    const rulesResp = await fetch('/api/alerts/rules');
                    const rulesData = await rulesResp.json();
                    document.getElementById('alertRulesCount').textContent = rulesData.rules ? rulesData.rules.length : 0;

                    // Calculate resolved count
                    const resolved = data.totals.total_alerts - data.totals.active_alerts;
                    document.getElementById('resolvedAlertsCount').textContent = resolved;
                }
            } catch (error) {
                console.error('Error loading alert statistics:', error);
            }
        }

        // Load active alerts
        async function loadActiveAlerts() {
            const container = document.getElementById('activeAlertsContainer');

            try {
                const response = await fetch('/api/alerts/history?days=7&status=triggered&limit=50');
                const data = await response.json();

                if (data.success) {
                    if (data.alerts.length === 0) {
                        container.innerHTML = '<p style="text-align: center; color: #4caf50; padding: 40px; font-size: 16px;">‚úì No active alerts</p>';
                        return;
                    }

                    let html = '<div style="display: grid; gap: 12px;">';

                    data.alerts.forEach(alert => {
                        const severityColors = {
                            'critical': '#d32f2f',
                            'error': '#f57c00',
                            'warning': '#ffa726',
                            'info': '#42a5f5'
                        };

                        const bgColors = {
                            'critical': '#ffebee',
                            'error': '#fff3e0',
                            'warning': '#fff8e1',
                            'info': '#e3f2fd'
                        };

                        const severityColor = severityColors[alert.severity] || '#666';
                        const bgColor = bgColors[alert.severity] || '#f5f5f5';

                        const triggeredTime = new Date(alert.triggered_at);
                        const timeAgo = getTimeAgo(triggeredTime);

                        html += `
                            <div style="background: ${bgColor}; padding: 15px; border-radius: 8px; border-left: 5px solid ${severityColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            <span style="background: ${severityColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${alert.severity}</span>
                                            <strong style="color: #003366; font-size: 15px;">${alert.camera_name}</strong>
                                        </div>
                                        <div style="color: #555; margin-bottom: 8px;">${alert.message}</div>
                                        <div style="font-size: 12px; color: #666;">
                                            <span>Rule: ${alert.rule_name || 'N/A'}</span> ‚Ä¢
                                            <span>Triggered: ${timeAgo}</span>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-primary" onclick="acknowledgeAlert(${alert.id}, '${alert.camera_name}')" style="padding: 6px 12px; font-size: 13px;">Acknowledge</button>
                                        <button class="btn btn-success" onclick="resolveAlert(${alert.id}, '${alert.camera_name}')" style="padding: 6px 12px; font-size: 13px;">Resolve</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading active alerts:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading active alerts</p>';
            }
        }

        // Load alert rules
        async function loadAlertRules() {
            const container = document.getElementById('alertRulesContainer');

            try {
                const response = await fetch('/api/alerts/rules');
                const data = await response.json();

                if (data.success) {
                    if (data.rules.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 40px;">No alert rules configured</p>';
                        return;
                    }

                    let html = '<div style="display: grid; gap: 12px;">';

                    data.rules.forEach(rule => {
                        const severityColors = {
                            'critical': '#d32f2f',
                            'error': '#f57c00',
                            'warning': '#ffa726',
                            'info': '#42a5f5'
                        };

                        const severityColor = severityColors[rule.severity] || '#666';
                        const enabledBadge = rule.enabled ?
                            '<span style="background: #4caf50; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">ENABLED</span>' :
                            '<span style="background: #999; color: white; padding: 3px 10px; border-radius: 12px; font-size: 11px;">DISABLED</span>';

                        html += `
                            <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #ddd; border-left: 5px solid ${severityColor};">
                                <div style="display: flex; justify-content: space-between; align-items: start;">
                                    <div style="flex: 1;">
                                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                            ${enabledBadge}
                                            <strong style="color: #003366; font-size: 15px;">${rule.rule_name}</strong>
                                        </div>
                                        <div style="color: #666; margin-bottom: 8px;">${rule.description || 'No description'}</div>
                                        <div style="font-size: 13px; color: #666;">
                                            <span>Type: ${rule.rule_type}</span> ‚Ä¢
                                            <span>Severity: <strong style="color: ${severityColor};">${rule.severity}</strong></span> ‚Ä¢
                                            <span>Applies to: ${rule.applies_to}</span>
                                            ${rule.threshold_value ? ` ‚Ä¢ Threshold: ${rule.threshold_operator} ${rule.threshold_value}%` : ''}
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 8px;">
                                        <button class="btn btn-secondary" onclick="toggleAlertRule(${rule.id}, ${rule.enabled})" style="padding: 6px 12px; font-size: 13px;">${rule.enabled ? 'Disable' : 'Enable'}</button>
                                        <button class="btn btn-danger" onclick="deleteAlertRule(${rule.id}, '${rule.rule_name}')" style="padding: 6px 12px; font-size: 13px;">Delete</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    html += '</div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading alert rules:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading alert rules</p>';
            }
        }

        // Load alert history
        async function loadAlertHistory() {
            const container = document.getElementById('alertHistoryContainer');
            const days = document.getElementById('historyDaysFilter').value;
            const severity = document.getElementById('historySeverityFilter').value;

            try {
                let url = `/api/alerts/history?days=${days}&limit=100`;
                if (severity) url += `&severity=${severity}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.success) {
                    if (data.alerts.length === 0) {
                        container.innerHTML = '<p style="text-align: center; padding: 40px;">No alert history found</p>';
                        return;
                    }

                    let html = '<div style="overflow-x: auto;"><table style="width: 100%; border-collapse: collapse;">';
                    html += `
                        <thead>
                            <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                <th style="padding: 12px; text-align: left;">Time</th>
                                <th style="padding: 12px; text-align: left;">Camera</th>
                                <th style="padding: 12px; text-align: center;">Severity</th>
                                <th style="padding: 12px; text-align: left;">Message</th>
                                <th style="padding: 12px; text-align: center;">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                    `;

                    data.alerts.forEach((alert, idx) => {
                        const bgColor = idx % 2 === 0 ? '#fff' : '#f9f9f9';
                        const severityColors = {
                            'critical': '#d32f2f',
                            'error': '#f57c00',
                            'warning': '#ffa726',
                            'info': '#42a5f5'
                        };

                        const statusColors = {
                            'triggered': '#f44336',
                            'acknowledged': '#ff9800',
                            'resolved': '#4caf50',
                            'auto_resolved': '#8bc34a'
                        };

                        const severityColor = severityColors[alert.severity] || '#666';
                        const statusColor = statusColors[alert.status] || '#666';

                        const triggeredTime = new Date(alert.triggered_at);
                        const timeStr = triggeredTime.toLocaleString();

                        html += `
                            <tr style="background: ${bgColor}; border-bottom: 1px solid #eee;">
                                <td style="padding: 10px; font-size: 12px;">${timeStr}</td>
                                <td style="padding: 10px;"><strong>${alert.camera_name}</strong></td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="background: ${severityColor}; color: white; padding: 3px 8px; border-radius: 10px; font-size: 11px;">${alert.severity}</span>
                                </td>
                                <td style="padding: 10px; color: #555;">${alert.message}</td>
                                <td style="padding: 10px; text-align: center;">
                                    <span style="color: ${statusColor}; font-weight: 600; font-size: 13px;">${alert.status}</span>
                                </td>
                            </tr>
                        `;
                    });

                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                }
            } catch (error) {
                console.error('Error loading alert history:', error);
                container.innerHTML = '<p style="color: #d32f2f;">Error loading alert history</p>';
            }
        }

        // Acknowledge an alert
        async function acknowledgeAlert(alertId, cameraName) {
            if (!confirm(`Acknowledge alert for ${cameraName}?`)) return;

            try {
                const response = await fetch(`/api/alerts/history/${alertId}/acknowledge`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ acknowledged_by: 'operator' })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Alert acknowledged', 'success');
                    loadActiveAlerts();
                    loadAlertStatistics();
                } else {
                    showNotification(data.error || 'Failed to acknowledge alert', 'error');
                }
            } catch (error) {
                console.error('Error acknowledging alert:', error);
                showNotification('Error acknowledging alert', 'error');
            }
        }

        // Resolve an alert
        async function resolveAlert(alertId, cameraName) {
            const notes = prompt(`Resolve alert for ${cameraName}. Resolution notes (optional):`);
            if (notes === null) return; // User cancelled

            try {
                const response = await fetch(`/api/alerts/history/${alertId}/resolve`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        resolved_by: 'operator',
                        resolution_notes: notes || 'Manually resolved'
                    })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Alert resolved', 'success');
                    loadActiveAlerts();
                    loadAlertStatistics();
                } else {
                    showNotification(data.error || 'Failed to resolve alert', 'error');
                }
            } catch (error) {
                console.error('Error resolving alert:', error);
                showNotification('Error resolving alert', 'error');
            }
        }

        // Toggle alert rule enabled/disabled
        async function toggleAlertRule(ruleId, currentlyEnabled) {
            try {
                const response = await fetch(`/api/alerts/rules/${ruleId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ enabled: !currentlyEnabled })
                });

                const data = await response.json();

                if (data.success) {
                    showNotification(`Alert rule ${currentlyEnabled ? 'disabled' : 'enabled'}`, 'success');
                    loadAlertRules();
                    loadAlertStatistics();
                } else {
                    showNotification(data.error || 'Failed to update alert rule', 'error');
                }
            } catch (error) {
                console.error('Error toggling alert rule:', error);
                showNotification('Error updating alert rule', 'error');
            }
        }

        // Delete alert rule
        async function deleteAlertRule(ruleId, ruleName) {
            if (!confirm(`Delete alert rule "${ruleName}"? This will also delete all alert history for this rule.`)) return;

            try {
                const response = await fetch(`/api/alerts/rules/${ruleId}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    showNotification('Alert rule deleted', 'success');
                    loadAlertRules();
                    loadAlertStatistics();
                } else {
                    showNotification(data.error || 'Failed to delete alert rule', 'error');
                }
            } catch (error) {
                console.error('Error deleting alert rule:', error);
                showNotification('Error deleting alert rule', 'error');
            }
        }

        // Open create alert rule modal (placeholder - to be implemented)
        function openCreateAlertRuleModal() {
            alert('Create Alert Rule feature coming soon! For now, alert rules are pre-configured in the database.');
        }

        // Helper: Get time ago string
        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);

            if (seconds < 60) return `${seconds} seconds ago`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)} minutes ago`;
            if (seconds < 86400) return `${Math.floor(seconds / 3600)} hours ago`;
            return `${Math.floor(seconds / 86400)} days ago`;
        }

        // Load cameras and trends on startup
        loadCameras();
        loadTrends();
        loadAiAnalysis();
    </script>

    <!-- Snapshot Viewer Modal -->
    <div id="snapshotModal" class="snapshot-modal" onclick="closeSnapshotModal()">
        <span class="snapshot-modal-close">&times;</span>
        <img class="snapshot-modal-content" id="snapshotModalImg" onclick="event.stopPropagation()">
        <div id="snapshotCaption" style="text-align: center; color: white; padding: 10px; font-size: 18px;"></div>
    </div>
</body>
</html>
