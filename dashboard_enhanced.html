<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FDOT CCTV Operations Tool</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; background: #f5f5f5; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { color: #003366; font-size: 28px; }
        .subtitle { color: #666; margin-top: 5px; }

        .toolbar { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .search-input { width: 100%; padding: 12px 20px; font-size: 16px; border: 2px solid #ddd; border-radius: 6px; margin-bottom: 15px; }
        .search-input:focus { outline: none; border-color: #003366; }

        .bulk-actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; padding-top: 15px; border-top: 1px solid #eee; }
        .btn { background: #003366; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 500; }
        .btn:hover { background: #004488; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; }
        .btn-secondary:hover { background: #5a6268; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }

        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .stat-value { font-size: 32px; font-weight: bold; color: #003366; }
        .stat-label { color: #666; margin-top: 5px; font-size: 14px; }

        .filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 16px; border: 2px solid #ddd; background: white; border-radius: 4px; cursor: pointer; font-size: 14px; }
        .filter-btn.active { border-color: #003366; background: #003366; color: white; }

        .camera-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; }
        .camera-card { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: transform 0.2s; }
        .camera-card:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .camera-card.selected { border: 2px solid #003366; }

        .camera-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .camera-checkbox { width: 18px; height: 18px; cursor: pointer; }
        .camera-name { font-weight: 600; color: #003366; flex: 1; }
        .health-indicator { width: 12px; height: 12px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .health-online { background: #4caf50; box-shadow: 0 0 6px rgba(76, 175, 80, 0.6); }
        .health-degraded { background: #ff9800; box-shadow: 0 0 6px rgba(255, 152, 0, 0.6); }
        .health-offline { background: #f44336; box-shadow: 0 0 6px rgba(244, 67, 54, 0.6); }
        .health-unknown { background: #9e9e9e; }
        .camera-info { font-size: 14px; color: #666; margin: 4px 0; margin-left: 28px; }

        .camera-snapshot { margin: 10px 0 10px 28px; border-radius: 6px; overflow: hidden; cursor: pointer; }
        .camera-snapshot img { width: 100%; height: auto; display: block; transition: opacity 0.2s; }
        .camera-snapshot img:hover { opacity: 0.9; }
        .snapshot-placeholder { background: #f5f5f5; padding: 40px; text-align: center; color: #999; font-size: 12px; }

        .snapshot-modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); }
        .snapshot-modal-content { margin: 2% auto; display: block; max-width: 90%; max-height: 90%; }
        .snapshot-modal-close { position: absolute; top: 20px; right: 40px; color: white; font-size: 40px; font-weight: bold; cursor: pointer; }
        .snapshot-modal-close:hover { color: #ccc; }

        .camera-actions { display: flex; gap: 8px; margin-top: 12px; margin-left: 28px; }
        .action-btn { padding: 6px 12px; font-size: 13px; border-radius: 4px; border: none; cursor: pointer; }
        .action-btn.reboot { background: #dc3545; color: white; }
        .action-btn.reboot:hover { background: #c82333; }
        .action-btn.snapshot { background: #28a745; color: white; }
        .action-btn.snapshot:hover { background: #218838; }

        .loading { text-align: center; padding: 40px; color: #666; }
        .no-results { text-align: center; padding: 40px; color: #999; }

        /* Modal */
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal.show { display: flex; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .modal-header { font-size: 20px; font-weight: 600; color: #003366; margin-bottom: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 10px; border: 2px solid #ddd; border-radius: 4px; font-size: 14px; }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: #003366; }
        .form-textarea { resize: vertical; min-height: 80px; }
        .modal-footer { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }

        /* Notifications */
        .notification { position: fixed; top: 20px; right: 20px; background: white; padding: 20px 25px; border-radius: 8px; box-shadow: 0 6px 12px rgba(0,0,0,0.2); z-index: 2000; display: none; min-width: 350px; max-width: 500px; white-space: pre-line; font-size: 16px; font-weight: 500; }
        .notification.show { display: block; animation: slideIn 0.3s ease; }
        .notification.success { border-left: 6px solid #28a745; background: #f0fff4; }
        .notification.error { border-left: 6px solid #dc3545; background: #fff5f5; }
        .notification.info { border-left: 6px solid #17a2b8; background: #f0f9ff; }
        @keyframes slideIn { from { transform: translateX(400px); } to { transform: translateX(0); } }

        /* Floating Progress Indicator */
        .progress-float { position: fixed; bottom: 20px; right: 20px; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 6px 16px rgba(0,0,0,0.3); z-index: 1999; display: none; min-width: 400px; max-width: 500px; border-left: 6px solid #003366; }
        .progress-float.show { display: block; animation: slideUp 0.3s ease; }
        .progress-float-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .progress-float-title { font-weight: bold; color: #003366; font-size: 16px; }
        .progress-float-close { cursor: pointer; font-size: 20px; color: #999; line-height: 1; padding: 0 5px; }
        .progress-float-close:hover { color: #333; }
        @keyframes slideUp { from { transform: translateY(400px); } to { transform: translateY(0); } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üé• FDOT CCTV Operations Tool</h1>
            <div class="subtitle">District 3 Camera Management System</div>
        </header>

        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalCameras">-</div>
                <div class="stat-label">Total Cameras</div>
            </div>
            <div class="stat-card" style="background: #e8f5e9;">
                <div class="stat-value" style="color: #2e7d32;" id="onlineCameras">-</div>
                <div class="stat-label">üü¢ Online</div>
            </div>
            <div class="stat-card" style="background: #fff3e0;">
                <div class="stat-value" style="color: #f57c00;" id="degradedCameras">-</div>
                <div class="stat-label">üü° Degraded</div>
            </div>
            <div class="stat-card" style="background: #ffebee;">
                <div class="stat-value" style="color: #c62828;" id="offlineCameras">-</div>
                <div class="stat-label">üî¥ Offline</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="systemHealth">-</div>
                <div class="stat-label">System Health</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="problemCameras">-</div>
                <div class="stat-label">Problem Cameras</div>
            </div>
        </div>

        <div class="toolbar">
            <input type="text" class="search-input" id="searchInput" placeholder="üîç Search cameras by name, IP, location, or highway (e.g., 'I10', '10.164', 'MM 5')..." />

            <div class="filters">
                <button class="filter-btn active" onclick="filterHighway('all')">All</button>
                <button class="filter-btn" onclick="filterHighway('I10')">I-10</button>
                <button class="filter-btn" onclick="filterHighway('I110')">I-110</button>
                <button class="filter-btn" onclick="filterHighway('US90')">US-90</button>
                <button class="filter-btn" onclick="filterHighway('US98')">US-98</button>
                <span style="margin: 0 10px; color: #ccc;">|</span>
                <button class="filter-btn" onclick="filterHealth('online')">üü¢ Online Only</button>
                <button class="filter-btn" onclick="filterHealth('offline')">üî¥ Offline Only</button>
                <button class="filter-btn" onclick="filterHealth('problem')">‚ö†Ô∏è Problem Cameras</button>
            </div>

            <div class="bulk-actions">
                <button class="btn btn-secondary" onclick="testAllCameras()">üîç Test All</button>
                <button class="btn btn-secondary" onclick="selectAll()">Select All</button>
                <button class="btn btn-secondary" onclick="deselectAll()">Deselect All</button>
                <button class="btn btn-danger" onclick="bulkReboot()" id="bulkRebootBtn" disabled>Reboot Selected</button>
                <button class="btn btn-success" onclick="bulkSnapshot()" id="bulkSnapshotBtn" disabled>Snapshot Selected</button>
            </div>
        </div>

        <div id="cameraContainer">
            <div class="loading">Loading cameras...</div>
        </div>
    </div>

    <!-- Reboot Modal -->
    <div id="rebootModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Reboot Camera</div>
            <div class="form-group">
                <label class="form-label">Camera:</label>
                <div id="rebootCameraName" style="font-weight: 600;"></div>
            </div>
            <div class="form-group">
                <label class="form-label">Operator Name: *</label>
                <input type="text" class="form-input" id="rebootOperator" placeholder="Your name" />
            </div>
            <div class="form-group">
                <label class="form-label">Reason for Reboot: *</label>
                <textarea class="form-textarea" id="rebootReason" placeholder="e.g., Camera not responding, scheduled maintenance"></textarea>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeRebootModal()">Cancel</button>
                <button class="btn btn-danger" onclick="confirmReboot()">Reboot Camera</button>
            </div>
        </div>
    </div>

    <!-- Snapshot Modal -->
    <div id="snapshotModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Capture Snapshots</div>
            <div class="form-group">
                <label class="form-label">Cameras Selected: <span id="snapshotCameraCount">0</span></label>
            </div>
            <div class="form-group">
                <label class="form-label">Operator Name: *</label>
                <input type="text" class="form-input" id="snapshotOperator" placeholder="Your name" />
            </div>
            <div class="form-group">
                <label class="form-label">Duration (minutes): *</label>
                <input type="number" class="form-input" id="snapshotDuration" value="60" min="1" max="1440" />
            </div>
            <div class="form-group">
                <label class="form-label">Interval (seconds): *</label>
                <input type="number" class="form-input" id="snapshotInterval" value="300" min="30" max="3600" />
            </div>
            <div class="form-group">
                <label class="form-label">Email Results To:</label>
                <input type="text" class="form-input" id="snapshotEmails" placeholder="email1@domain.com, email2@domain.com (optional)" />
                <small style="color: #666; font-size: 12px;">Leave blank for no email, or enter comma-separated addresses</small>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSnapshotModal()">Cancel</button>
                <button class="btn btn-success" id="snapshotStartBtn" onclick="confirmSnapshot()">Start Capture</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="notification"></div>

    <!-- Floating Progress Indicator -->
    <div id="snapshotProgressFloat" class="progress-float">
        <div class="progress-float-header">
            <div class="progress-float-title">üì∏ Capturing Snapshots...</div>
            <div class="progress-float-close" onclick="hideSnapshotProgress()">√ó</div>
        </div>
        <div style="margin-bottom: 10px;">
            <span id="snapshotProgressText" style="font-weight: bold; color: #003366; font-size: 18px;">0%</span>
        </div>
        <div style="width: 100%; background: #e0e0e0; border-radius: 10px; height: 25px; overflow: hidden;">
            <div id="snapshotProgressBar" style="width: 0%; background: linear-gradient(90deg, #003366, #0066cc); height: 100%; transition: width 0.3s; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 12px;"></div>
        </div>
        <div id="snapshotProgressDetails" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
    </div>

    <script>
        let allCameras = [];
        let healthData = {};
        let healthStats = {};
        let currentFilter = 'all';
        let healthFilter = 'all';
        let selectedCameras = new Set();
        let currentRebootCamera = null;
        let currentSnapshotSession = null;
        let snapshotProgressInterval = null;

        // Load cameras on page load
        async function loadCameras() {
            try {
                console.log('Loading cameras...');
                const response = await fetch('/api/cameras/list');
                console.log('Response received:', response.status);
                const data = await response.json();
                console.log('Data parsed:', data.total, 'cameras');
                allCameras = data.cameras;
                document.getElementById('totalCameras').textContent = data.total;

                // Display cameras immediately
                const container = document.getElementById('cameraContainer');
                container.innerHTML = '<div class="camera-grid">' + allCameras.map(cam => `
                    <div class="camera-card ${selectedCameras.has(cam.id) ? 'selected' : ''}" id="card-${cam.id}">
                        <div class="camera-header">
                            <input type="checkbox" class="camera-checkbox"
                                   ${selectedCameras.has(cam.id) ? 'checked' : ''}
                                   onchange="toggleCamera('${cam.id}')" />
                            <div class="camera-name">${cam.name}<span class="health-indicator health-unknown"></span></div>
                        </div>
                        <div class="camera-info">üìç ${cam.location}</div>
                        <div class="camera-info">üåê ${cam.ip}</div>
                        <div class="camera-actions">
                            <button class="action-btn reboot" onclick="showRebootModal('${cam.id}')">üîÑ Reboot</button>
                            <button class="action-btn snapshot" onclick="snapshotSingle('${cam.id}')">üì∏ Snapshot</button>
                        </div>
                    </div>
                `).join('') + '</div>';

                // Load health data after cameras are displayed
                loadHealthData();
            } catch (error) {
                console.error('Error loading cameras:', error);
                document.getElementById('cameraContainer').innerHTML = '<div class="no-results">Error loading cameras: ' + error.message + '</div>';
            }
        }

        // Load health data
        async function loadHealthData() {
            try {
                console.log('Loading health data...');
                const response = await fetch('/api/dashboard/health');
                const data = await response.json();

                // Create health lookup by camera name
                healthData = {};
                if (data.cameras) {
                    data.cameras.forEach(cam => {
                        healthData[cam.camera_name] = cam;
                    });
                }
                console.log('Health data loaded for', Object.keys(healthData).length, 'cameras');

                // Store statistics
                healthStats = data.statistics || {};

                // Update stats display
                updateHealthStats();

                // Update health indicators on existing camera cards
                allCameras.forEach(cam => {
                    const card = document.getElementById('card-' + cam.id);
                    if (card) {
                        const nameDiv = card.querySelector('.camera-name');
                        if (nameDiv) {
                            const health = healthData[cam.name];
                            const indicator = nameDiv.querySelector('.health-indicator');
                            if (indicator && health) {
                                indicator.className = 'health-indicator health-' + health.status;
                                indicator.title = health.status.charAt(0).toUpperCase() + health.status.slice(1) +
                                    (health.last_check ? ' (checked ' + new Date(health.last_check).toLocaleString() + ')' : '');
                            }
                        }
                    }
                });
                console.log('Health indicators updated');
            } catch (error) {
                console.error('Error loading health data:', error);
            }
        }

        // Update health statistics display
        function updateHealthStats() {
            document.getElementById('onlineCameras').textContent = healthStats.online || 0;
            document.getElementById('degradedCameras').textContent = healthStats.degraded || 0;
            document.getElementById('offlineCameras').textContent = healthStats.offline || 0;
            document.getElementById('systemHealth').textContent = (healthStats.system_health_percentage || 0) + '%';
            document.getElementById('problemCameras').textContent = healthStats.problem_cameras || 0;
        }

        // Test all cameras
        async function testAllCameras() {
            try {
                showNotification('Starting health check for all cameras...', 'info');
                const response = await fetch('/api/cameras/test-all', { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    showNotification(data.message + '\nResults will update shortly...', 'success');
                    // Reload health data after 5 seconds
                    setTimeout(loadHealthData, 5000);
                }
            } catch (error) {
                showNotification('Error starting health check', 'error');
            }
        }

        // Get health indicator HTML
        function getHealthIndicator(cameraName) {
            const health = healthData[cameraName];
            if (!health) {
                return '<span class="health-indicator health-unknown" title="Unknown status"></span>';
            }
            const statusClass = 'health-' + health.status;
            const title = health.status.charAt(0).toUpperCase() + health.status.slice(1) +
                          (health.last_check ? ' (checked ' + new Date(health.last_check).toLocaleString() + ')' : '');
            return `<span class="health-indicator ${statusClass}" title="${title}"></span>`;
        }

        // Display cameras
        function displayCameras(cameras) {
            const container = document.getElementById('cameraContainer');

            if (cameras.length === 0) {
                container.innerHTML = '<div class="no-results">No cameras found</div>';
                return;
            }

            container.innerHTML = '<div class="camera-grid">' + cameras.map(cam => {
                const healthIndicator = getHealthIndicator(cam.name);
                const snapshotUrl = `/static/snapshots/${cam.ip}.jpg?t=${Date.now()}`;
                const health = healthData[cam.name];
                let responseTimeInfo = '';
                if (health && (health.avg_ping_ms || health.avg_snapshot_ms)) {
                    const pingTime = health.avg_ping_ms ? `${Math.round(health.avg_ping_ms)}ms` : 'N/A';
                    const snapTime = health.avg_snapshot_ms ? `${Math.round(health.avg_snapshot_ms)}ms` : 'N/A';
                    responseTimeInfo = `<div class="camera-info">‚è±Ô∏è Ping: ${pingTime} | Snapshot: ${snapTime}</div>`;
                }
                return `
                <div class="camera-card ${selectedCameras.has(cam.id) ? 'selected' : ''}" id="card-${cam.id}">
                    <div class="camera-header">
                        <input type="checkbox" class="camera-checkbox"
                               ${selectedCameras.has(cam.id) ? 'checked' : ''}
                               onchange="toggleCamera('${cam.id}')" />
                        <div class="camera-name">${cam.name}${healthIndicator}</div>
                    </div>
                    <div class="camera-info">üìç ${cam.location}</div>
                    <div class="camera-info">üåê ${cam.ip}</div>
                    ${responseTimeInfo}
                    <div class="camera-snapshot" onclick="viewSnapshot('${cam.ip}', '${cam.name}')">
                        <img src="${snapshotUrl}" alt="${cam.name} snapshot"
                             onerror="this.parentElement.innerHTML='<div class=\\'snapshot-placeholder\\'>No snapshot available</div>'" />
                    </div>
                    <div class="camera-actions">
                        <button class="action-btn reboot" onclick="showRebootModal('${cam.id}')">üîÑ Reboot</button>
                        <button class="action-btn snapshot" onclick="snapshotSingle('${cam.id}')">üì∏ Snapshot</button>
                    </div>
                </div>
            `}).join('') + '</div>';

            updateSelectionCount();
        }

        // Toggle camera selection
        function toggleCamera(cameraId) {
            if (selectedCameras.has(cameraId)) {
                selectedCameras.delete(cameraId);
            } else {
                selectedCameras.add(cameraId);
            }
            updateSelectionCount();

            const card = document.getElementById('card-' + cameraId);
            if (card) {
                card.classList.toggle('selected', selectedCameras.has(cameraId));
            }
        }

        // Update selection count and buttons
        function updateSelectionCount() {
            const count = selectedCameras.size;
            document.getElementById('selectedCameras').textContent = count;
            document.getElementById('bulkRebootBtn').disabled = count === 0;
            document.getElementById('bulkSnapshotBtn').disabled = count === 0;
        }

        // Select/Deselect all
        function selectAll() {
            const displayed = document.querySelectorAll('.camera-card');
            displayed.forEach(card => {
                const id = card.id.replace('card-', '');
                selectedCameras.add(id);
                card.classList.add('selected');
                const checkbox = card.querySelector('.camera-checkbox');
                if (checkbox) checkbox.checked = true;
            });
            updateSelectionCount();
        }

        function deselectAll() {
            selectedCameras.clear();
            document.querySelectorAll('.camera-card').forEach(card => {
                card.classList.remove('selected');
                const checkbox = card.querySelector('.camera-checkbox');
                if (checkbox) checkbox.checked = false;
            });
            updateSelectionCount();
        }

        // Search cameras
        document.getElementById('searchInput').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.length < 2) {
                filterCameras(currentFilter);
                return;
            }

            const filtered = allCameras.filter(cam =>
                cam.name.toLowerCase().includes(query) ||
                cam.ip.includes(query) ||
                cam.location.toLowerCase().includes(query)
            );
            displayCameras(filtered);
        });

        // Filter by highway
        function filterHighway(highway) {
            currentFilter = highway;
            healthFilter = 'all'; // Reset health filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayCameras(getFilteredCameras());
        }

        // Filter by health status
        function filterHealth(status) {
            healthFilter = status;
            currentFilter = 'all'; // Reset highway filter
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            displayCameras(getFilteredCameras());
        }

        // Get filtered cameras based on current filters
        function getFilteredCameras() {
            let filtered = allCameras;

            // Apply highway filter
            if (currentFilter !== 'all') {
                filtered = filtered.filter(cam => cam.location.includes(currentFilter));
            }

            // Apply health filter
            if (healthFilter !== 'all') {
                filtered = filtered.filter(cam => {
                    const health = healthData[cam.name];
                    if (!health) return healthFilter === 'unknown';

                    if (healthFilter === 'online') {
                        return health.status === 'online';
                    } else if (healthFilter === 'offline') {
                        return health.status === 'offline' || health.status === 'degraded';
                    } else if (healthFilter === 'problem') {
                        return health.consecutive_failures >= 3;
                    }
                    return true;
                });
            }

            return filtered;
        }

        function filterCameras(highway) {
            // Deprecated - kept for compatibility
            filterHighway(highway);
        }

        // Show reboot modal
        function showRebootModal(cameraId) {
            const camera = allCameras.find(c => c.id === cameraId);
            if (!camera) return;

            currentRebootCamera = camera;
            document.getElementById('rebootCameraName').textContent = camera.name;
            document.getElementById('rebootOperator').value = '';
            document.getElementById('rebootReason').value = '';
            document.getElementById('rebootModal').classList.add('show');
        }

        function closeRebootModal() {
            document.getElementById('rebootModal').classList.remove('show');
            currentRebootCamera = null;
        }

        // Confirm reboot
        async function confirmReboot() {
            const operator = document.getElementById('rebootOperator').value.trim();
            const reason = document.getElementById('rebootReason').value.trim();

            if (!operator || !reason) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            if (!currentRebootCamera) return;

            try {
                const response = await fetch('/api/camera/reboot', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        camera_ip: currentRebootCamera.ip,
                        camera_name: currentRebootCamera.name,
                        operator: operator,
                        reason: reason
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    let message = `‚úì Camera ${currentRebootCamera.name} rebooted successfully!`;
                    if (result.ticket_id) {
                        message += `\n\nüé´ MIMS Ticket Created: #${result.ticket_id}`;
                    }
                    showNotification(message, 'success');
                } else {
                    let message = `‚úó Reboot failed: ${result.message || 'Unknown error'}`;
                    if (result.ticket_id) {
                        message += `\n\nüé´ MIMS Ticket Created: #${result.ticket_id}`;
                        message += `\n(Failure documented for maintenance team)`;
                    }
                    showNotification(message, 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }

            closeRebootModal();
        }

        // Bulk reboot
        async function bulkReboot() {
            if (selectedCameras.size === 0) return;

            const operator = prompt('Enter your name:');
            if (!operator) return;

            const reason = prompt('Enter reason for reboot:');
            if (!reason) return;

            let success = 0;
            let failed = 0;

            for (const cameraId of selectedCameras) {
                const camera = allCameras.find(c => c.id === cameraId);
                if (!camera) continue;

                try {
                    const response = await fetch('/api/camera/reboot', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            camera_ip: camera.ip,
                            camera_name: camera.name,
                            operator: operator,
                            reason: reason
                        })
                    });

                    if (response.ok) success++;
                    else failed++;
                } catch (error) {
                    failed++;
                }
            }

            showNotification(`Bulk reboot complete: ${success} succeeded, ${failed} failed`, success > 0 ? 'success' : 'error');
            deselectAll();
        }

        // Single camera snapshot
        function snapshotSingle(cameraId) {
            selectedCameras.clear();
            selectedCameras.add(cameraId);
            updateSelectionCount();
            bulkSnapshot();
        }

        // Bulk snapshot
        function bulkSnapshot() {
            if (selectedCameras.size === 0) return;

            document.getElementById('snapshotCameraCount').textContent = selectedCameras.size;
            document.getElementById('snapshotOperator').value = '';
            document.getElementById('snapshotModal').classList.add('show');
        }

        function closeSnapshotModal() {
            document.getElementById('snapshotModal').classList.remove('show');
            document.getElementById('snapshotStartBtn').disabled = false;
        }

        function hideSnapshotProgress() {
            stopSnapshotProgress();
            document.getElementById('snapshotProgressFloat').classList.remove('show');
        }

        // Confirm snapshot
        async function confirmSnapshot() {
            const operator = document.getElementById('snapshotOperator').value.trim();
            const duration = parseInt(document.getElementById('snapshotDuration').value);
            const interval = parseInt(document.getElementById('snapshotInterval').value);
            const emailInput = document.getElementById('snapshotEmails').value.trim();

            if (!operator) {
                showNotification('Please enter operator name', 'error');
                return;
            }

            // Parse email addresses
            const emailAddresses = emailInput ? emailInput.split(',').map(e => e.trim()).filter(e => e) : [];

            const cameras = Array.from(selectedCameras).map(id => {
                const cam = allCameras.find(c => c.id === id);
                return { ip: cam.ip, name: cam.name };
            });

            try {
                const payload = {
                    cameras: cameras,
                    duration_minutes: duration,
                    interval_seconds: interval,
                    operator: operator,
                    output_format: 'shared_folder'
                };

                // Add email settings if addresses provided
                if (emailAddresses.length > 0) {
                    payload.email_report = true;
                    payload.email_recipients = emailAddresses;
                }

                const response = await fetch('/api/snapshot/capture', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok) {
                    currentSnapshotSession = result.session_id || Date.now().toString();
                    showNotification(`Snapshot capture started! Progress shown in bottom-right corner.`, 'success');

                    // Close modal and show floating progress
                    closeSnapshotModal();
                    document.getElementById('snapshotProgressFloat').classList.add('show');
                    updateSnapshotProgress(0, duration, 0, 0, cameras.length);
                    startSnapshotProgress(duration, cameras.length);
                } else {
                    showNotification(`Snapshot failed: ${result.message || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                showNotification(`Error: ${error.message}`, 'error');
            }

            deselectAll();
        }

        // Start snapshot progress tracking
        function startSnapshotProgress(durationMinutes, cameraCount) {
            const startTime = Date.now();
            const endTime = startTime + (durationMinutes * 60 * 1000);

            snapshotProgressInterval = setInterval(() => {
                const now = Date.now();
                const elapsed = now - startTime;
                const total = endTime - startTime;
                const progress = Math.min(100, (elapsed / total) * 100);
                const elapsedMinutes = Math.floor(elapsed / 60000);
                const elapsedSeconds = Math.floor((elapsed % 60000) / 1000);

                updateSnapshotProgress(progress, durationMinutes, elapsedMinutes, elapsedSeconds, cameraCount);

                if (progress >= 100) {
                    stopSnapshotProgress();
                    showNotification('Snapshot capture complete! Check shared folder for results.', 'success');
                    setTimeout(() => hideSnapshotProgress(), 3000);
                }
            }, 1000);
        }

        // Stop snapshot progress tracking
        function stopSnapshotProgress() {
            if (snapshotProgressInterval) {
                clearInterval(snapshotProgressInterval);
                snapshotProgressInterval = null;
            }
        }

        // Update snapshot progress display
        function updateSnapshotProgress(percent, totalMinutes, elapsedMin, elapsedSec, cameraCount) {
            const progressBar = document.getElementById('snapshotProgressBar');
            const progressText = document.getElementById('snapshotProgressText');
            const progressDetails = document.getElementById('snapshotProgressDetails');

            progressBar.style.width = percent + '%';
            progressBar.textContent = Math.floor(percent) + '%';
            progressText.textContent = Math.floor(percent) + '%';

            const remainingMin = totalMinutes - elapsedMin;
            const remainingDisplay = remainingMin > 0 ? `${remainingMin} min remaining` : 'Finishing...';
            progressDetails.textContent = `${cameraCount} camera(s) ‚Ä¢ ${elapsedMin}m ${elapsedSec}s elapsed ‚Ä¢ ${remainingDisplay}`;
        }

        // Show notification
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 5000);
        }

        // View snapshot in modal
        function viewSnapshot(ip, cameraName) {
            const modal = document.getElementById('snapshotModal');
            const modalImg = document.getElementById('snapshotModalImg');
            const caption = document.getElementById('snapshotCaption');

            modal.style.display = 'block';
            modalImg.src = `/static/snapshots/${ip}.jpg?t=${Date.now()}`;
            caption.textContent = `${cameraName} (${ip})`;
        }

        function closeSnapshotModal() {
            document.getElementById('snapshotModal').style.display = 'none';
        }

        // Close modal on click outside image
        window.onclick = function(event) {
            const modal = document.getElementById('snapshotModal');
            if (event.target == modal) {
                closeSnapshotModal();
            }
        }

        // Load cameras on startup
        loadCameras();
    </script>

    <!-- Snapshot Viewer Modal -->
    <div id="snapshotModal" class="snapshot-modal" onclick="closeSnapshotModal()">
        <span class="snapshot-modal-close">&times;</span>
        <img class="snapshot-modal-content" id="snapshotModalImg" onclick="event.stopPropagation()">
        <div id="snapshotCaption" style="text-align: center; color: white; padding: 10px; font-size: 18px;"></div>
    </div>
</body>
</html>
